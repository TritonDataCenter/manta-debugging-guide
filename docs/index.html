<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Manta Debugging Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Manta Debugging Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_incident_response_decision_tree">Incident Response Decision Tree</a>
<ul class="sectlevel2">
<li><a href="#_investigating_a_decrease_in_overall_throughput">Investigating a decrease in overall throughput</a></li>
<li><a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a></li>
<li><a href="#_investigating_an_increase_in_error_rate">Investigating an increase in error rate</a>
<ul class="sectlevel3">
<li><a href="#_response_code_507">Response code 507</a></li>
<li><a href="#_response_code_503">Response code 503</a></li>
<li><a href="#_response_code_502">Response code 502</a></li>
<li><a href="#_response_code_500">Response code 500</a></li>
<li><a href="#_response_code_499">Response code 499</a></li>
<li><a href="#_other_400_level_response_codes">Other 400-level response codes</a></li>
</ul>
</li>
<li><a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a>
<ul class="sectlevel3">
<li><a href="#_if_you_have_the_code_x_request_id_code_and_code_x_server_name_code_headers">If you have the <code>x-request-id</code> and <code>x-server-name</code> headers</a></li>
<li><a href="#_if_you_have_the_code_x_request_id_code_but_no_code_x_server_name_code">If you have the <code>x-request-id</code>, but no <code>x-server-name</code></a></li>
<li><a href="#_if_you_don_t_have_the_code_x_request_id_code">If you don&#8217;t have the <code>x-request-id</code></a></li>
<li><a href="#_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</a></li>
</ul>
</li>
<li><a href="#_investigating_elevated_electric_moray_latency">Investigating elevated Electric-Moray latency</a></li>
<li><a href="#_investigating_elevated_moray_latency">Investigating elevated Moray latency</a></li>
<li><a href="#_investigating_elevated_postgresql_latency">Investigating elevated PostgreSQL latency</a></li>
</ul>
</li>
<li><a href="#_basic_investigation_tasks">Basic investigation tasks</a>
<ul class="sectlevel2">
<li><a href="#_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</a></li>
<li><a href="#_investigating_postgresql_latency">Investigating PostgreSQL latency</a></li>
<li><a href="#_finding_or_generating_a_failed_request">Finding (or generating) a failed request</a></li>
<li><a href="#_checking_recent_historical_metrics">Checking recent historical metrics</a></li>
<li><a href="#_locating_log_files">Locating log files</a></li>
<li><a href="#_understanding_a_muskie_log_entry">Understanding a Muskie log entry</a>
<ul class="sectlevel3">
<li><a href="#_contents_of_a_get_log_entry">Contents of a GET log entry</a></li>
<li><a href="#_contents_of_a_put_log_entry">Contents of a PUT log entry</a></li>
</ul>
</li>
<li><a href="#_understanding_latency_for_a_specific_request">Understanding latency for a specific request</a></li>
<li><a href="#_finding_a_load_balancer_log_entry">Finding a load balancer log entry</a>
<ul class="sectlevel3">
<li><a href="#_when_to_investigate_the_load_balancer">When to investigate the load balancer</a></li>
<li><a href="#_finding_load_balancer_log_entries">Finding load balancer log entries</a></li>
</ul>
</li>
<li><a href="#_understanding_a_load_balancer_log_entry">Understanding a load balancer log entry</a></li>
<li><a href="#_build_a_request_timeline">Build a request timeline</a></li>
<li><a href="#_details_about_specific_error_messages">Details about specific error messages</a>
<ul class="sectlevel3">
<li><a href="#__code_no_storage_nodes_available_for_this_request_code"><code>No storage nodes available for this request</code></a></li>
<li><a href="#__code_not_enough_free_space_for_mb_code"><code>Not enough free space for ... MB</code></a></li>
</ul>
</li>
<li><a href="#_locating_metadata_for_an_object">Locating metadata for an object</a></li>
<li><a href="#_locating_actual_data_for_an_object">Locating actual data for an object</a></li>
<li><a href="#_locating_a_particular_server">Locating a particular server</a></li>
<li><a href="#_locating_a_particular_zone">Locating a particular zone</a></li>
<li><a href="#_locating_a_particular_database_shard">Locating a particular database shard</a></li>
<li><a href="#_finding_what_shard_a_particular_zone_is_part_of">Finding what shard a particular zone is part of</a></li>
<li><a href="#_save_debugging_state_and_restart_a_process">Save debugging state and restart a process</a></li>
<li><a href="#_investigating_service_discovery">Investigating service discovery</a></li>
<li><a href="#_investigating_a_slow_process">Investigating a slow process</a></li>
<li><a href="#_investigating_why_a_process_is_on_cpu">Investigating why a process is on-CPU</a></li>
<li><a href="#_investigating_why_a_process_is_off_cpu">Investigating why a process is off-CPU</a></li>
<li><a href="#_check_for_a_garbage_collection_issue_or_memory_leak">Check for a garbage collection issue (or memory leak)</a></li>
<li><a href="#_scaling_up_a_component">Scaling up a component</a></li>
<li><a href="#_characterizing_a_problem">Characterizing a problem</a></li>
</ul>
</li>
<li><a href="#_quick_references">Quick references</a>
<ul class="sectlevel2">
<li><a href="#_manta_http_quick_reference">Manta HTTP Quick Reference</a>
<ul class="sectlevel3">
<li><a href="#_http_status_codes_in_manta">HTTP Status Codes in Manta</a></li>
<li><a href="#_http_headers_in_manta">HTTP Headers in Manta</a></li>
<li><a href="#_requests_using_100_continue">Requests using "100-continue"</a></li>
<li><a href="#_streaming_vs_fixed_size_requests">Streaming vs. fixed-size requests</a></li>
<li><a href="#_validating_the_contents_of_requests_and_responses">Validating the contents of requests and responses</a></li>
</ul>
</li>
<li><a href="#_muskie_log_entry_properties">Muskie log entry properties</a>
<ul class="sectlevel3">
<li><a href="#_general_muskie_provided_properties">General Muskie-provided properties</a></li>
<li><a href="#_muskie_provided_properties_for_debugging_only">Muskie-provided properties for debugging only</a></li>
<li><a href="#__a_href_https_github_com_trentm_node_bunyan_core_fields_bunyan_a_provided_properties"><a href="https://github.com/trentm/node-bunyan#core-fields">Bunyan</a>-provided properties</a></li>
</ul>
</li>
<li><a href="#_debugging_tools_quick_reference">Debugging tools quick reference</a></li>
<li><a href="#_glossary_of_jargon">Glossary of jargon</a></li>
</ul>
</li>
<li><a href="#_deployment_specific_details">Deployment-specific details</a></li>
<li><a href="#_metrics">Metrics</a>
<ul class="sectlevel2">
<li><a href="#_predicting_autovacuum_activity">Predicting autovacuum activity</a>
<ul class="sectlevel3">
<li><a href="#_background_on_vacuum_in_manta">Background on vacuum in Manta</a></li>
<li><a href="#_using_metrics_to_predict_normal_autovacuums">Using metrics to predict normal autovacuums</a></li>
<li><a href="#_using_metrics_to_predict_anti_wraparound_autovacuums">Using metrics to predict anti-wraparound autovacuums</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document is intended for operators and developers of Manta seeking to better understand Manta&#8217;s runtime behavior, both under normal operation and during incident response.</p>
</div>
<div class="paragraph">
<p>You may find other documentation helpful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/joyent/manta">Manta GitHub Project</a></p>
</li>
<li>
<p><a href="http://joyent.github.io/manta/">Manta Operator&#8217;s Guide</a></p>
</li>
<li>
<p><a href="https://apidocs.joyent.com/manta/">Manta End User Documentation</a></p>
</li>
<li>
<p><a href="https://github.com/joyent/manta-tools-deck">Manta Tools (slide deck)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This document is organized into a few broad sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_incident_response_decision_tree">Incident Response Decision Tree</a>: this chapter attempts to walk you
through the process of understanding common problems with Manta.  This often
links directly to specific common tasks later in the document.</p>
</li>
<li>
<p><a href="#_basic_investigation_tasks">Basic investigation tasks</a>: this chapter covers a number of different
specific tasks associated with debugging Manta, like understanding a Muskie
log entry, checking what instances of a service are registered in DNS, and so
on.</p>
</li>
<li>
<p><a href="#_quick_references">Quick references</a> to HTTP status codes and headers used in Manta</p>
</li>
<li>
<p><a href="#_deployment_specific_details">Deployment-specific details</a>: this chapter lists a number of details that
your company or organization should separately document.</p>
</li>
<li>
<p><strong>General FAQ</strong></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_incident_response_decision_tree">Incident Response Decision Tree</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Choose a place to start:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_investigating_a_decrease_in_overall_throughput">Investigating a decrease in overall throughput</a></p>
</li>
<li>
<p><a href="#_investigating_an_increase_in_error_rate">Investigating an increase in error rate</a></p>
</li>
<li>
<p><a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a></p>
</li>
<li>
<p><a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Many of these sections refer to checking recent historical metrics.  See
<a href="#_deployment_specific_details">Deployment-specific details</a> for more information.</strong></p>
</div>
<div class="sect2">
<h3 id="_investigating_a_decrease_in_overall_throughput">Investigating a decrease in overall throughput</h3>
<div class="paragraph">
<p>Start here if you have reason to believe that inbound or outbound throughput to
Manta has recently been reduced.</p>
</div>
<div class="paragraph">
<p>First, <strong>can you confirm the decrease in throughput from Manta&#8217;s own metrics?</strong>
If not, the problem may be external to Manta.  Since problems often unfold over
several minutes, you may have to look back over several hours to get a sense of
recent throughput.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-webapi-bytes-falling-1.png" alt="metrics webapi bytes falling 1">
</div>
<div class="title">Figure 1. A sudden drop in inbound throughput after several hours of steady performance.</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Has the error rate increased?</strong>  Check recent historical metrics for an
increase in 400-level or 500-level errors.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, there&#8217;s an increase in the overall error rate.</strong>  See
<a href="#_investigating_an_increase_in_error_rate">Investigating an increase in error rate</a>.  It may be that many requests
that were previously accounting for throughput are now failing.  (If the
error rate is not high enough to account for the change in throughput, then
it may be useful to investigate latency instead.)</p>
<div class="openblock">
<div class="content">
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-webapi-errors-spike-1.png" alt="Spike in 503 errors">
</div>
<div class="title">Figure 2. A transient spike in 503 errors.  (Note the absolute number is extremely low here.  To see this against a larger number of successful requests, you may need to click on "503" in the legend to show only the 503s.)</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>No, the error rate is unchanged.</strong>  <strong>Has webapi latency increased?</strong>  Check
recent historical metrics for an increase in average latency, p90 latency, or
p95 latency.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, webapi latency has increased.</strong>  See
<a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a>.</p>
<div class="openblock">
<div class="content">
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-webapi-latency-increasing-1.png" alt="metrics webapi latency increasing 1">
</div>
<div class="title">Figure 3. An increase in webapi tail latency.</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>No, webapi latency is unchanged or lower.</strong>  If there are no errors and no
increased latency, then Manta appears healthy.  Check upstream network
connections, client metrics, and client behavior.  (e.g., has the client
changed its workload?)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Background:</strong> By definition, the throughput of the system (either inbound or
outbound) is the number of <code>completed requests per second</code> times <code>average
request size</code> (in terms of inbound or outbound bytes, depending on which
throughput you&#8217;re interested in).  <strong>If throughput is lower, then one of the
following is likely true:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>There are fewer requests per second because there&#8217;s a fixed concurrency and
average request latency has increased.</strong>  This is generally a server problem.
For example, it&#8217;s common for there to be a fixed number of clients, each with
a fixed maximum concurrency.  In that situation, if Manta requests start
taking twice as long, then the number of requests completed per second will
naturally be cut in half, cutting overall throughput in half.</p>
</li>
<li>
<p><strong>Average request size has reduced because requests are failing (resulting in
small requests).</strong>  This is generally a server problem, though it could also be
a client problem.  For example, if the average upload is 10 MiB, but suddenly
10% of requests are failing before they reach the upload stage, overall
throughput is likely to degrade by 10%, since 10% of requests are now
uploading almost no data.</p>
</li>
<li>
<p><strong>There are fewer requests per second because clients are making fewer
requests.</strong>  This would be a client change (and may not be an issue).  For
example, this could happen when an operator turns off some clients.</p>
</li>
<li>
<p><strong>Average request size has reduced because of a deliberate change in the
client workload.</strong>  This would be a client change (and may not be an issue).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_an_increase_in_latency">Investigating an increase in latency</h3>
<div class="paragraph">
<p>When there&#8217;s reason to suspect an overall increase in webapi latency, real-time
metric dashboards can be used to identify the source.  The first step is
typically confirming whether latency is visible at webapi.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>A Manta deployment can easily execute tens of thousands of requests per
second, each with an associated latency.  It&#8217;s useful to summarize a large
number of latencies with a single number so that we can identify trends, both
for raising alarms and for general situational awareness during incident
response.</p>
</div>
<div class="paragraph">
<p><strong>Average latency</strong> is the sum of latencies divided by the request count.  This
is useful for understanding changes in throughput, since throughput changes that
result from increased latency would manifest as increased average latency.</p>
</div>
<div class="paragraph">
<p>However, normal-looking averages can obscure high-latency requests that have an
outsize impact on clients.  As a result, we often focus on <strong>tail latency</strong>, or
the latencies of the slowest requests.  The notation <strong>p99</strong> refers to the 99th
percentile latency, which is the latency value where 99% of requests completed
within this latency.  If the p90 is 300ms, then 90% of requests completed within
300ms.</p>
</div>
<div class="paragraph">
<p>When making broad statements about latency, it&#8217;s helpful to be specific about
whether you&#8217;re talking about average latency or tail latency.  However, the
questions below are intentionally ambiguous, as increases in either average or
tail latency might be cause for further investigation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-webapi-latency-increasing-1.png" alt="metrics webapi latency increasing 1">
</div>
<div class="title">Figure 4. A steady increase in webapi tail latency.</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-webapi-latency-spike-1.png" alt="metrics webapi latency spike 1">
</div>
<div class="title">Figure 5. A transient spike in webapi tail latency.</div>
</div>
<div class="paragraph">
<p><strong>Has latency at Muskie increased?</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No, Muskie latency has not increased.</strong>  There does not appear to be an
increase in latency from Manta.  If clients are reporting elevated latency,
try to confirm that.  One approach is to collect information from a client
about a specific slow request and <a href="#_build_a_request_timeline">build a request
timeline</a>.  This can
help determine if latency is coming from within Manta or not.</p>
</li>
<li>
<p><strong>Yes, Muskie latency has increased.</strong>  At this point, you can
<a href="#_finding_or_generating_a_failed_request">find or generate a specific slow
request</a> and then <a href="#_understanding_latency_for_a_specific_request">understand
its latency</a>.
But when you&#8217;re looking at a trend like this, it&#8217;s often helpful to look at
latency at other parts of the system.  The next question is: <strong>Has latency at
Electric-Moray increased?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, latency has increased at Electric-Moray, too.</strong>  In this case, <strong>has
latency at Moray increased as well?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, latency has increased at Moray, too.</strong> See below.</p>
</li>
<li>
<p><strong>No, there&#8217;s no corresponding increase in latency at Moray.</strong>  This is
unusual.  There may be a problem with particular electric-moray instances, or
the whole tier may be overloaded.  See
<a href="#_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>No, there&#8217;s no corresponding increase in latency at Electric-Moray.</strong>  This
is unusual.  There may be a problem with particular webapi instances, or the
whole tier may be overloaded.  See
<a href="#_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-latency-correlation-1.png" alt="metrics latency correlation 1">
</div>
<div class="title">Figure 6. A <em>decrease</em> in webapi latency that&#8217;s well correlated with a decrease in maximum Moray tail latency across all shards.</div>
</div>
<div class="paragraph">
<p>If you found above that latency at Moray has increased, take a look at the
Moray latency metrics broken out by shard name (or zonename, and then
<a href="#_finding_what_shard_e_particular_zone_is_part_of">map the zonenames to shard
names</a>).  Remember to ignore shard 1.  <strong>Have multiple Moray shards seen an
increase in latency?</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No, only one shard has elevated latency.</strong>  You&#8217;ll need to dig into the
behavior of this shard.  See below.</p>
</li>
<li>
<p><strong>Yes, multiple Moray shards have elevated latency.</strong>  Moray shards are
generally independent, so problems with multiple shards may need to be
investigated separately.  On the other hand, you may wind up looking at
system-wide PostgreSQL metrics next, in which case you may be able to answer
questions about several shards at once.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you&#8217;ve established that a particular shard&#8217;s Moray latency has increased,
the next step is to identify if it&#8217;s Moray or PostgreSQL that&#8217;s the source of
the latency.  This is a bit more difficult than previous steps because we do not
have metrics for p99 query latency from PostgreSQL.</p>
</div>
<div class="paragraph">
<p>There are a couple of different questions to ask:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Are all Moray zones affected in the same way?</strong>  Specifically, compare tail
latency, average latency (if possible), and queue depth across zones for this
shard.  Are all of them elevated, or are some different than others?</p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, all Moray zones in this shard appear affected in the same way.</strong>  This
suggests a problem with PostgreSQL rather than Moray.</p>
</li>
<li>
<p><strong>No, some Moray zones in this shard appear much more affected than others.</strong>
This is more likely to reflect a problem with specific Moray instances rather
than PostgreSQL.  See the question below about database connections, and see
also <a href="#_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Is there a high rate of Moray queueing on this shard, relative to other
shards?</strong>  If there&#8217;s a high rate of queueing, the database might be the
source of the latency.  If not, it&#8217;s possible that Moray is the source of the
problem.</p>
</li>
<li>
<p>If there is queueing at Moray, check the number of backend
connections (or processes) reported on the PostgreSQL dashboard.  <strong>Does this
shard have the same number of database connections as other shards?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, this shard has the same number of connections as other shards.</strong> Move
on to other questions.</p>
</li>
<li>
<p><strong>No, this shard has fewer connections than other shards.</strong>  This may
indicate a connection management problem at Moray.  If Moray instances lose
track of connections, they may be limited in how much work they can dispatch
to PostgreSQL, resulting in increased latency as requests queue up.</p>
</li>
<li>
<p><strong>No, this shard has far more connections than other shards.</strong>  If this shard
has over 500 connections, that may indicate a problem with Moray.  There are
generally supposed to be at most 64 connections per Moray zone in this shard,
and we usually deploy 3-6 zones per shard.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Based on these questions, if it seems like the problem is associated with
PostgreSQL, see <a href="#_investigating_postgresql_latency">Investigating PostgreSQL latency</a>.  Otherwise, the problem
is likely with Moray.  See <a href="#_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_an_increase_in_error_rate">Investigating an increase in error rate</h3>
<div class="paragraph">
<p>There are a couple of major kinds of error.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>500-level response</strong> (that is, a well-formed HTTP response with a status
code between 500 and 599) generally reflects a problem with Manta.</p>
</li>
<li>
<p>A <strong>400-level response</strong> (that is, a well-formed HTTP response with a status
code between 400 and 499) may happen under normal operation and may indicate
no problem at all, or it may reflect a client issue.  In rare cases, a 499
response can reflect a server issue.  The details depend on the specific type
of error and whether the client expects it or not.</p>
</li>
<li>
<p>If the client gives up before the server has sent a response, then the client
will likely report a <em>client timeout</em>, while the server will likely report a
connection that was abruptly closed by the client.</p>
</li>
<li>
<p>If there&#8217;s a networking issue that causes the client or server to abandon the
connection, both sides will generally report an explicit socket error.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_response_code_507">Response code 507</h4>
<div class="paragraph">
<p>See <a href="#_not_enough_free_space_for_mb">[_not_enough_free_space_for_mb]</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_response_code_503">Response code 503</h4>
<div class="paragraph">
<p>A <code>503 Service Unavailable</code> response generally indicates that Manta is refusing
some requests because it is overloaded or some dependencies are not functioning.
There are three major cases where this happens:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At least one Moray instance is at its maximum queue length and is refusing new
requests.</p>
</li>
<li>
<p>There are not enough online storage nodes to handle the upload.</p>
</li>
<li>
<p>Muskie did not respond to the request quickly enough.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all cases, you can <a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a> to
find the cause of the failure.</p>
</div>
<div class="paragraph">
<p><strong>If you already have a particular 503 response,</strong> you can quickly determine
which of these cases caused it.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Does the response have <code>x-server-name</code> and <code>x-request-id</code> headers?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>No, these headers are missing.</strong>  This indicates Muskie took too long to
respond.  See either <a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a>
(for just this one request) or <a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a> (for
a large number).</p>
</li>
<li>
<p><strong>Yes, these headers are present.</strong>  In this case, the error message in the
body of the response will indicate the problem.  See
<a href="#_details_about_specific_error_messages">Details about specific error messages</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>If you have a large number of 503s,</strong> you can check for systemic causes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Are there Moray shards with high queue lengths?</strong>  Check recent historical
metrics for Moray queue length.  If any zone or shard has more than a few
thousand items queued, it may be causing 503-level responses.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, some shards have long Moray queues.</strong>  See
<a href="#_investigating_elevated_moray_latency">Investigating elevated Moray latency</a>.</p>
</li>
<li>
<p><strong>No shard has long queues.</strong>  See
<a href="#_finding_or_generating_a_failed_request">Finding (or generating) a failed request</a> to find a Muskie log entry with
more details about the source of the 503.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_response_code_502">Response code 502</h4>
<div class="paragraph">
<p>Manta no longer issues this response code.  If you see it, please file a bug.
Historically, this was associated with slow Muskie requests.  These are
generally now reported as 503s.</p>
</div>
</div>
<div class="sect3">
<h4 id="_response_code_500">Response code 500</h4>
<div class="paragraph">
<p>This generally indicates a server-side bug.  See
<a href="#_finding_or_generating_a_failed_request">Finding (or generating) a failed request</a> to learn why the request failed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_response_code_499">Response code 499</h4>
<div class="paragraph">
<p>499 is an internal status code used to describe when a client appears to have
abandoned a request.  Specifically, this is recorded when a client closes its
socket before finishing a request.  In this case, there is no response, since
the server may have no place to send it.</p>
</div>
<div class="paragraph">
<p>499s may be seen if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the client gave up (timed out) before the server sent an initial response
(e.g., a <code>100-continue</code>)</p>
</li>
<li>
<p>the client crashed (closing its sockets)</p>
</li>
<li>
<p>a network issue disrupted the connection between client and server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>If you have a specific 499 request&#8217;s Muskie log entry already</strong> (as from a
<a href="#_finding_or_generating_a_failed_request">Muskie log</a>), was the latency fairly
high?  (If you know the client&#8217;s timeout, was the request latency longer than
this timeout?)  Check the "latency" field in the Muskie log entry.  Also compare
the <code>Date</code> header in the request with the timestamp of the log entry.  If these
don&#8217;t match up, the request may have been queued somewhere before being
processed by Muskie.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, the request took several seconds (and/or longer than the client&#8217;s
timeout).</strong>  Elevated Muskie latency may be the reason for the 499.  See
either <a href="#_understanding_latency_for_a_specific_request">Understanding latency for a specific request</a> or (if you have a lot
of them) <a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a>.</p>
</li>
<li>
<p><strong>No, the request was short (and/or shorter than the client&#8217;s timeout).</strong>
This appears to be a client issue.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_other_400_level_response_codes">Other 400-level response codes</h4>
<div class="paragraph">
<p>These are usually client issues, though it&#8217;s always possible there are
server-side bugs that cause erroneous 400-level responses.  The only way to be
sure is to examine the request and response to see if the response appears
correct.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</h3>
<div class="paragraph">
<p>Start here if you want to understand why a specific request has failed.  These
steps will help you find corresponding log entries with more detail.</p>
</div>
<div class="paragraph">
<p>Ideally, you&#8217;ll want to have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>x-server-name</code> header from the response</p>
</li>
<li>
<p>the <code>x-request-id</code> header from the response</p>
</li>
<li>
<p>the approximate time of the response (which calendar hour it was sent)</p>
</li>
<li>
<p>the IP address that the client used to reach Manta</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In many cases, you can get by with only some of this information.  The more
information you have, the easier (and faster) it will be to find more
information.</p>
</div>
<div class="paragraph">
<p>You might also try <a href="#_finding_or_generating_a_failed_request">generating your
own request</a> to investigate.</p>
</div>
<div class="paragraph">
<p>If you find the log entry, see <a href="#_understanding_a_muskie_log_entry">Understanding a Muskie log entry</a> for
details.  If you find none, see <a href="#_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</a>.</p>
</div>
<div class="sect3">
<h4 id="_if_you_have_the_code_x_request_id_code_and_code_x_server_name_code_headers">If you have the <code>x-request-id</code> and <code>x-server-name</code> headers</h4>
<div class="paragraph">
<p>The <code>x-server-name</code> header gives you the uuid for the "webapi" zone that
processed this request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Was the request completed after the top of the current hour?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, the request was handled after the top of the hour.</strong> The log entry will
be inside the Muskie zone.  First, <a href="#_locate_a_specific_zone">find the
datacenter where the Muskie zone that handled the request is deployed</a>.
From the headnode of that datacenter, use <code>manta-oneach</code> to search the Muskie
log file for the request id:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">manta-oneach -z WEBAPI_ZONE_UUID 'grep REQUEST_ID /var/log/muskie.log' | bunyan</code></pre>
</div>
</div>
<div class="paragraph">
<p>filling in <code>WEBAPI_ZONE_UUID</code> from the <code>x-server-name</code> header and <code>REQUEST_ID</code>
from the <code>x-request-id</code> header.</p>
</div>
</li>
<li>
<p><strong>No, the request was handled earlier than that.</strong>  The log entry will
generally be in a historical log file inside Manta itself.  Use <code>mlogin</code> or
<code>mget</code> to fetch the path:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">/poseidon/stor/logs/muskie/YYYY/MM/DD/HH/UUID8.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>YYYY/MM/DD/HH</code> represent the year, month, day, and hour when the request
completed and <code>UUID8</code> is the first 8 characters of the <code>x-server-name</code> header.
If this object does not exist in Manta, and Manta has been having availability
issues, then the historical log file may still be inside the corresponding
"webapi" zone.  <a href="#_log_into_a_specific_zone">Log into the "webapi" zone</a> and
use <code>grep</code> to search for the request ID in the files in <code>/var/log/manta/upload</code>.</p>
</div>
</li>
<li>
<p><strong>I don&#8217;t know when the request was handled.</strong>  In this case, you need to
check all of the log files mentioned above.  You may be able to use a Manta
job to scan a large number of historical files at once.  For example, you can
search all of a day&#8217;s log files for one server using:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mfind -t o -n UUID8.log /poseidon/stor/logs/muskie/YYYY/MM/DD |
    mjob create -o -m 'grep REQUEST_ID || true' -r bunyan</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, <code>UUID8</code> is the first 8 characters of the <code>x-server-name</code> header.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you find the log entry, see <a href="#_understanding_a_muskie_log_entry">Understanding a Muskie log entry</a> for
details.  If you find none, see <a href="#_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_you_have_the_code_x_request_id_code_but_no_code_x_server_name_code">If you have the <code>x-request-id</code>, but no <code>x-server-name</code></h4>
<div class="paragraph">
<p>In this case, you have to check the log files for all "webapi" zones to find the
log entry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Was the request completed since the top of the current hour?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, the request was handled since the top of the hour.</strong> The log entry will
be inside the Muskie zone.  Separately for <strong>each datacenter in this Manta</strong>,
use <code>manta-oneach</code> to search all the Muskie logs:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">manta-oneach -s webapi 'grep REQUEST_ID /var/log/muskie.log' | bunyan</code></pre>
</div>
</div>
</li>
<li>
<p><strong>No, the request was handled earlier than that.</strong>  Use a job to search
historical logs with names:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">/poseidon/stor/logs/muskie/YYYY/MM/DD/HH/*.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>YYYY/MM/DD/HH</code> represent the year, month, day, and hour when the request
completed.</p>
</div>
<div class="paragraph">
<p>For example, you can search all log files for a particular hour with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">mfind -t o /poseidon/stor/logs/muskie/YYYY/MM/DD/HH |
    mjob create -o -m 'grep REQUEST_ID || true' -r bunyan</code></pre>
</div>
</div>
</li>
<li>
<p><strong>I don&#8217;t know when the request was handled.</strong>  In this case, you need to
check all of the log files mentioned above.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you find the log entry, see <a href="#_understanding_a_muskie_log_entry">Understanding a Muskie log entry</a> for
details.  If you find none, see <a href="#_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_you_don_t_have_the_code_x_request_id_code">If you don&#8217;t have the <code>x-request-id</code></h4>
<div class="paragraph">
<p>If you don&#8217;t have the request id, then you&#8217;ll need some other information about
the request that you can use to filter it.  Examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the name of the account, if that account only made a few requests around the
time in question</p>
</li>
<li>
<p>the path that was used, if that&#8217;s relatively unique among requests</p>
</li>
<li>
<p>a particular client header that&#8217;s somewhat uncommon</p>
</li>
<li>
<p>a very small time window in which the request may have happened</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have this sort of information, your best bet is to use some combination
of <code>grep</code> or <code>json</code> to scan all of the log entries for the appropriate time.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When working out a <code>grep</code> or <code>json</code> pipeline, it&#8217;s helpful to use <code>mlogin</code>
to get an interactive shell for a particular Muskie log file.  There, you can
practice your shell pipeline a few times until it matches what you want,
possibly using slightly different parameters (e.g., a different account name)
than you&#8217;ll use for the real search, since you probably didn&#8217;t happen to pick a
log file with the precise entry you&#8217;re looking for).  Then run that same shell
pipeline in a Manta job over a much larger number of Muskie log files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you find the log entry, see <a href="#_understanding_a_muskie_log_entry">Understanding a Muskie log entry</a> for
details.  If you find none, see <a href="#_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_there_is_no_muskie_log_entry">If there is no Muskie log entry</h4>
<div class="paragraph">
<p>There&#8217;s a difference between there being <strong>no</strong> Muskie log entry and <strong>not being
able to find</strong> the Muskie log entry for a request.</p>
</div>
<div class="paragraph">
<p>You may <strong>know</strong> that there&#8217;s no log entry for a request if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you have the rough timestamp and x-server-name header, found a non-empty log
for that server for that hour, and there&#8217;s no entry for the request in it, or</p>
</li>
<li>
<p>you know the rough timestamp of the request, found non-empty log files for all
servers for that hour, and there&#8217;s no matching request</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, it&#8217;s possible that the log entry was lost (e.g., if a log file was
lost or clobbered, due to a bug or extended availability loss).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Did the HTTP response contain an <code>x-server-name</code> or <code>x-request-id</code> header?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, there was a response with these headers.</strong>  In this case, a Muskie
instance definitely handled the request.  There should be a log entry.</p>
</li>
<li>
<p><strong>There was a response, but it did not contain these headers.</strong>  In this
case, the response very likely came from the load balancer and <em>not</em> Muskie.
See <a href="#_finding_a_load_balancer_log_entry">Finding a load balancer log entry</a> to find more information about the
request.  This typically happens for one of two reasons:</p>
<div class="ulist">
<ul>
<li>
<p>Muskie took too long (usually more than two minutes) to handle the request.
Note that even though the load balancer may have reported a 500-level error,
the request may have completed successfully (or failed for some other
reason) inside Muskie.</p>
</li>
<li>
<p>Muskie did process the request, but it just took longer than the load
balancer timeout.  This is often a sign of high latency at the metadata
tier.</p>
</li>
<li>
<p>Muskie stopped processing a request.  This would be a bug in Muskie.  It
often leads to file descriptor leaks and memory leaks, so it&#8217;s very serious.
Examples: MANTA-3338, <a href="https://smartos.org/bugview/MANTA-2916">MANTA-2916</a>,
<a href="https://smartos.org/bugview/MANTA-2907">MANTA-2907</a>.</p>
</li>
<li>
<p>Muskie sent an invalid HTTP response.  (This is very uncommon.  Example:
<a href="http://smartos.org/bugview/MANTA-3489">MANTA-3489</a>)</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>There was no response, or the client timed out before receiving a
response.</strong>  It would be very unusual for the system to produce no response
within 2 minutes of a request being completed, but it&#8217;s not uncommon for a
client to give up before receiving a response.</p>
</li>
<li>
<p><strong>I don&#8217;t know if there was a response.</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all of these cases, you can get more information about what happened by
<a href="#_finding_a_load_balancer_log_entry">Finding a load balancer log entry</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_elevated_electric_moray_latency">Investigating elevated Electric-Moray latency</h3>

</div>
<div class="sect2">
<h3 id="_investigating_elevated_moray_latency">Investigating elevated Moray latency</h3>

</div>
<div class="sect2">
<h3 id="_investigating_elevated_postgresql_latency">Investigating elevated PostgreSQL latency</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_investigation_tasks">Basic investigation tasks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_investigating_a_slow_tier_of_node_processes">Investigating a slow tier of Node processes</h3>
<div class="paragraph">
<p>The following services within the Manta data path are Node.js-based:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Webapi (muskie)</p>
</li>
<li>
<p>Electric-Moray</p>
</li>
<li>
<p>Moray</p>
</li>
<li>
<p>Authcache (mahi)</p>
</li>
<li>
<p>Nameservice (not covered in this section)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section assumes that you&#8217;re looking at a specific tier of services
(i.e., one of the ones listed above).  <strong>If you&#8217;re looking at Moray
specifically, as you follow this section, consider only the Moray instances for
the particular shard you&#8217;re looking at.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, <strong>have you already confirmed that this tier is reporting high latency?</strong>
If not, check metric dashboards first to see whether latency is high.  See
<a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a>.</p>
</div>
<div class="paragraph">
<p>Next, <strong>have you also confirmed that the reason for the latency is not due to a
dependent service?</strong>  For example, if you&#8217;re here because of Electric-Moray,
have you confirmed that Moray isn&#8217;t also seeing high latency?  If you haven&#8217;t,
see <a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a> for how to locate which tier is
the origin of overall latency.</p>
</div>
<div class="paragraph">
<p>At this point, you&#8217;ve confirmed that this tier appears to be the source of a
latency increase.  Now, use the latency metric dashboards to see <strong>is the
increase in latency affecting nearly all instances?</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, nearly all instances are reporting high latency.</strong>  This might reflect
insufficient capacity.  Individual Node processes are usually close to
capacity when they exceed about 80-85% of CPU utilization.  Each component
typically has multiple processes deployed in each zone, which means the
saturation point (80-85% per process) is different for each type of zone:</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Processes per zone</th>
<th class="tableblock halign-left valign-top">Saturation point</th>
<th class="tableblock halign-left valign-top">Equivalent CPUs</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">webapi</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">13000% (zone-wide)</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">13 CPUs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">electric-moray</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">325% (zone-wide)</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">3.25 CPUs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">moray</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">325% (zone-wide)</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">3.25 CPUs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authcache</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">80% (zone-wide)</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.8 CPUs</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Given the above guides, use CPU utilization graphs to determine: <strong>are most
instances in this service close to CPU saturation?</strong>  (The
<a href="#_deployment_specific_details">Deployment-specific details</a> section recommends having both a line graph
showing the minimum zone-wide CPU usage for each service and a heat map of
zone-wide CPU utilization.  If the line graph is above these guidelines, the
service definitely looks saturated.  The heat map allows you to identify cases
where some instances might have more headroom available, but most of them are
still too busy.)</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, most instances are nearing saturation.</strong>  Deploy more instances of the
service in question.  See <a href="#_scaling_up_a_component">Scaling up a component</a>.  <strong>Additionally, if
the workload has not changed substantially, you may want to
<a href="#_check_for_a_garbage_collection_issue_or_memory_leak">check for a memory
leak</a> that may have affected many processes.</strong>  If it has, then deploying
more instances will likely only help for a little while&#8201;&#8212;&#8201;until those
suffer the same leak.</p>
</li>
<li>
<p><strong>No, many instances appear to have plenty of headroom.</strong>  This is very
unusual, so it&#8217;s worth double-checking that latency is elevated across the
board, but latency at dependent services is not high, and CPU utilization is
not high.  If this is really the case, pick any specific process showing high
latency and see <a href="#_investigating_a_slow_process">Investigating a slow process</a>.  Other avenues to
consider: <strong>is the dependent service close to CPU saturation?</strong> If so,
clients of the dependent service may see much higher latency than the service
reports because of queueing.  <strong>Is there evidence of elevated packet loss?</strong>
This can also increase client-side latency without manifesting as latency
reported by the dependent service.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>No, only some instances are reporting high latency.</strong>  In this case, this
service does not appear generally overloaded, although it&#8217;s possible that some
instances are.  Next question: <strong>can you tell from the per-request metrics for
this tier whether the workload is evenly distributed across instances?</strong></p>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, the workload is evenly distributed across instances.</strong>  In this case,
it appears that processes are generally doing comparable work, but some are
doing it much slower.  The next step is to <strong>use the dashboard to identify a
zone with particularly high latency and dig deeper into a specific slow
process</strong>.  See <a href="#_investigating_a_slow_process">Investigating a slow process</a>.</p>
</li>
<li>
<p><strong>No, the workload is unevenly distributed.</strong>  See
<a href="#_investigating_service_discovery">Investigating service discovery</a>.  (Remember, if you&#8217;re looking at Moray,
this section assumes you&#8217;re looking only at instances for a particular shard.
As described under <a href="#_investigating_an_increase_in_latency">Investigating an increase in latency</a>, if you see
latency at Moray, you should first isolate the shard and investigate latency
in each shard separately.)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_postgresql_latency">Investigating PostgreSQL latency</h3>

</div>
<div class="sect2">
<h3 id="_finding_or_generating_a_failed_request">Finding (or generating) a failed request</h3>
<div class="paragraph">
<p>When trying to understand either an explicit error or high latency, it can be
helpful to investigate the log entry written by "webapi" for a specific request.</p>
</div>
<div class="paragraph">
<p><strong>Do you already have information about a specific request you want to
investigate?</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Yes, I have information about a specific request.</strong> See
<a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a>.</p>
</li>
<li>
<p><strong>No, I don&#8217;t have information about a specific request yet.</strong>  Move on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Next question: <strong>does the problem appear to be reproducible?</strong>  Try reproducing
the problem with the <a href="https://github.com/joyent/node-manta">node-manta</a>
command-line tools (e.g., <code>mls</code>).  You can use the <code>-v</code> flag and redirect stderr
to the <a href="https://github.com/trentm/node-bunyan">bunyan</a> command to see request and
response headers, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">$ mls -v /poseidon/public 2&gt; &gt;(bunyan)
[2018-07-19T21:18:48.146Z] DEBUG: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/lib/client.js:1536 in ls): ls: entered (req_id=4b4927be-fc1f-4dd8-88fe-2ae75dcbc262, path=/poseidon/public)
[2018-07-19T21:18:48.148Z] DEBUG: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/lib/client.js:1128 in info): info: entered (req_id=0f34c68e-2072-405a-be3a-248e8020f1ba, path=/poseidon/public, id=0f34c68e-2072-405a-be3a-248e8020f1ba, query={})
    headers: {
      "accept": "application/json, */*",
      "x-request-id": "0f34c68e-2072-405a-be3a-248e8020f1ba"
    }
[2018-07-19T21:18:48.189Z] TRACE: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/node_modules/restify-clients/lib/HttpClient.js:314 in rawRequest): request sent
    HEAD /poseidon/public HTTP/1.1
    Host: us-east.manta.joyent.com:null
    accept: application/json, */*
    x-request-id: 0f34c68e-2072-405a-be3a-248e8020f1ba
    date: Thu, 19 Jul 2018 21:18:48 GMT
    authorization: Signature keyId="/dap/keys/56:f3:e1:56:3d:e6:f7:83:a9:ce:19:5d:62:ba:5c:1f",algorithm="rsa-sha1",headers="date",signature="kG7IydhNO06ImfI6hFzFXXoSrWT6+2kCcDUC3swGebIr7YxeDcLEWMxGzB4z5lC29Vv7kgpLGaTc218m+63D0Y3M84LTNCvM1Va5COetXhIHkkAlBtXpJt5MUjqsRFK1xrpGKJjDc1QIBGSQIDmh4p6wNjofeaLX8jYnYa7FagW5iyQIHQmpAwe/AO+9Bg7fXBgzfvVZjWfhLaBA4G2CwuCSlkpF7mR7t04pTn+oxOmufE5h6XI/VLNsLZyQkc6prBFDoSiOLMgZsGfdsF11J9c/lCK/PW1y4MlTZBDGG8W1F0ssUEx0euLdm4TsqoBc1cfeIC43fV6sR2nN/CSiow=="
    user-agent: restify/1.4.1 (x64-darwin; v8/4.5.103.53; OpenSSL/1.0.2o) node/4.9.1
    accept-version: ~1.0
[2018-07-19T21:18:48.861Z] TRACE: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/node_modules/restify-clients/lib/HttpClient.js:210 in onResponse): Response received
    HTTP/1.1 200 OK
    content-type: application/x-json-stream; type=directory
    result-set-size: 5
    date: Thu, 19 Jul 2018 21:18:48 GMT
    server: Manta
    x-request-id: 0f34c68e-2072-405a-be3a-248e8020f1ba
    x-response-time: 254
    x-server-name: 511ea59e-2a4a-486b-9258-ef59016d064d
    connection: keep-alive
    x-request-received: 1532035128176
    x-request-processing-time: 684
[2018-07-19T21:18:48.867Z] DEBUG: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/lib/client.js:820 in get): get: entered (req_id=dce478bd-6bc7-451b-ac2b-22d74d7bfd37, path=/poseidon/public, id=dce478bd-6bc7-451b-ac2b-22d74d7bfd37)
    headers: {
      "accept": "application/x-json-stream",
      "x-request-id": "4b4927be-fc1f-4dd8-88fe-2ae75dcbc262",
      "date": "Thu, 19 Jul 2018 21:18:48 GMT",
      "authorization": "Signature keyId=\"/dap/keys/56:f3:e1:56:3d:e6:f7:83:a9:ce:19:5d:62:ba:5c:1f\",algorithm=\"rsa-sha1\",headers=\"date\",signature=\"kG7IydhNO06ImfI6hFzFXXoSrWT6+2kCcDUC3swGebIr7YxeDcLEWMxGzB4z5lC29Vv7kgpLGaTc218m+63D0Y3M84LTNCvM1Va5COetXhIHkkAlBtXpJt5MUjqsRFK1xrpGKJjDc1QIBGSQIDmh4p6wNjofeaLX8jYnYa7FagW5iyQIHQmpAwe/AO+9Bg7fXBgzfvVZjWfhLaBA4G2CwuCSlkpF7mR7t04pTn+oxOmufE5h6XI/VLNsLZyQkc6prBFDoSiOLMgZsGfdsF11J9c/lCK/PW1y4MlTZBDGG8W1F0ssUEx0euLdm4TsqoBc1cfeIC43fV6sR2nN/CSiow==\""
    }
    --
    query: {
      "limit": 1024
    }
[2018-07-19T21:18:48.872Z] TRACE: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/node_modules/restify-clients/lib/HttpClient.js:314 in rawRequest): request sent
    GET /poseidon/public?limit=1024 HTTP/1.1
    Host: us-east.manta.joyent.com:null
    accept: application/x-json-stream
    x-request-id: 4b4927be-fc1f-4dd8-88fe-2ae75dcbc262
    date: Thu, 19 Jul 2018 21:18:48 GMT
    authorization: Signature keyId="/dap/keys/56:f3:e1:56:3d:e6:f7:83:a9:ce:19:5d:62:ba:5c:1f",algorithm="rsa-sha1",headers="date",signature="kG7IydhNO06ImfI6hFzFXXoSrWT6+2kCcDUC3swGebIr7YxeDcLEWMxGzB4z5lC29Vv7kgpLGaTc218m+63D0Y3M84LTNCvM1Va5COetXhIHkkAlBtXpJt5MUjqsRFK1xrpGKJjDc1QIBGSQIDmh4p6wNjofeaLX8jYnYa7FagW5iyQIHQmpAwe/AO+9Bg7fXBgzfvVZjWfhLaBA4G2CwuCSlkpF7mR7t04pTn+oxOmufE5h6XI/VLNsLZyQkc6prBFDoSiOLMgZsGfdsF11J9c/lCK/PW1y4MlTZBDGG8W1F0ssUEx0euLdm4TsqoBc1cfeIC43fV6sR2nN/CSiow=="
    user-agent: restify/1.4.1 (x64-darwin; v8/4.5.103.53; OpenSSL/1.0.2o) node/4.9.1
    accept-version: ~1.0
[2018-07-19T21:18:49.365Z] TRACE: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/node_modules/restify-clients/lib/HttpClient.js:210 in onResponse): Response received
    HTTP/1.1 200 OK
    content-type: application/x-json-stream; type=directory
    result-set-size: 5
    date: Thu, 19 Jul 2018 21:18:49 GMT
    server: Manta
    x-request-id: 4b4927be-fc1f-4dd8-88fe-2ae75dcbc262
    x-response-time: 219
    x-server-name: 60771e58-2ad0-4c50-8b23-86b72f9307f8
    connection: keep-alive
    transfer-encoding: chunked
    x-request-received: 1532035128869
    x-request-processing-time: 496
-rwxr-xr-x 1 poseidon            17 Dec 04  2015 agent.sh
drwxr-xr-x 1 poseidon             0 Sep 18  2014 manatee
drwxr-xr-x 1 poseidon             0 Jun 18  2013 medusa
drwxr-xr-x 1 poseidon             0 Aug 01  2013 minke
drwxr-xr-x 1 poseidon             0 Nov 07  2013 stud
[2018-07-19T21:18:49.480Z] DEBUG: mls/MantaClient/7054 on zathras.local (/Users/dap/install/node-v4.9.1-darwin-x64/lib/node_modules/manta/lib/client.js:887 in onEnd): get: done (req_id=dce478bd-6bc7-451b-ac2b-22d74d7bfd37, path=/poseidon/public)</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the output, we can see that this operation made two requests.  The second
one has <code>x-server-name: 60771e58-2ad0-4c50-8b23-86b72f9307f8</code> and <code>x-request-id:
4b4927be-fc1f-4dd8-88fe-2ae75dcbc262</code>.  You can now use these to start
<a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a>.</p>
</div>
<div class="paragraph">
<p><strong>If the problem isn&#8217;t quite so easily reproducible, but you suspect it still
affects a variety of requests,</strong> you can use
<a href="https://github.com/joyent/manta-mlive">manta-mlive</a> to generate more requests and
collect debug output for all of them.  For <code>mlive</code>, you&#8217;ll want to set
<code>LOG_LEVEL</code> in the environment to generate the debug logging and you&#8217;ll likely
want to redirect stderr to a file that you can search through later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">$ LOG_LEVEL=trace ./bin/mlive -S 2&gt;debug.out
2018-07-19T21:24:01.307Z: reads okay, writes stuck (4/4 ok since start)
2018-07-19T21:24:02.310Z: all okay (17/17 ok since 2018-07-19T21:24:01.307Z)
^C</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, you can use the <code>bunyan</code> tool to format the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">$ bunyan debug.out
...
[2018-07-19T21:25:01.716Z] TRACE: mlive/MantaClient/9435 on zathras.local: request sent
    HEAD /dap/stor/mlive HTTP/1.1
    Host: us-east.manta.joyent.com:null
    accept: application/json, */*
    x-request-id: c317603c-82d4-4b2e-ac4b-066c9ece1864
    date: Thu, 19 Jul 2018 21:25:01 GMT
    authorization: Signature keyId="/dap/keys/56:f3:e1:56:3d:e6:f7:83:a9:ce:19:5d:62:ba:5c:1f",algorithm="rsa-sha1",headers="date",signature="oJZZIDh1qT8PeSSpz09bIzYT4LYK6rqXS2G5bHhh2r37SNOs0vBkFHUhfso6tSq1hmHIlkCEMXX9zGLIvYxQtHj6/KtiNgZgyWzGHms+qhc2gziXnOrMybxmWqJwipd8rAJCdDBV0B5FlCDeELWIA+1LifGDqqLdDZT4ScBUNOm9JG2+mha2U+pFbNtaXQQyyoPgopk+4ur4OHYpcaK/KY6WdC91quLIaIKV28VMtPoN/q/15lzRj6G6L7mbIMyd48ut0EbmTTR/CfYq9dquNsWDlyWgEJJVYyPZ9odAE34YQiYt/N4JXH7Crr9M6md9GtZonY+DbP8vvb5+7xr8dA=="
    user-agent: restify/1.4.1 (x64-darwin; v8/4.5.103.53; OpenSSL/1.0.2o) node/4.9.1
    accept-version: ~1.0
[2018-07-19T21:25:02.548Z] TRACE: mlive/MantaClient/9435 on zathras.local: Response received
    HTTP/1.1 200 OK
    last-modified: Tue, 16 Dec 2014 01:17:29 GMT
    content-type: application/x-json-stream; type=directory
    result-set-size: 45
    date: Thu, 19 Jul 2018 21:25:02 GMT
    server: Manta
    x-request-id: c317603c-82d4-4b2e-ac4b-066c9ece1864
    x-response-time: 462
    x-server-name: 39adec6c-bded-4a14-9d80-5a8bfc1121f9
    connection: keep-alive
    x-request-received: 1532035501703
    x-request-processing-time: 844</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use <code>grep</code>, <code>json</code>, or other tools to filter the output for requests of
interest (e.g., those with a particular HTTP response code or an
<code>x-response-time</code> larger than some value).  From the filtered results, you can
identify an <code>x-server-name</code> and <code>x-request-id</code> and then see
<a href="#_investigating_a_specific_request_that_has_failed">Investigating a specific request that has failed</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_checking_recent_historical_metrics">Checking recent historical metrics</h3>

</div>
<div class="sect2">
<h3 id="_locating_log_files">Locating log files</h3>
<div class="paragraph">
<p><strong>Real-time logs</strong> contain data from the current hour.  These are typically
stored as regular files within each zone.  The specific file used varies by type
of zone.  See the <a href="https://joyent.github.io/manta/#logs">Operator Guide</a> for
details.  The <code>manta-oneach</code> command can be used as a low-level way to scan
these real-time logs.  For example, a common way to count recent 500-level
errors in webapi logs is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>manta-oneach --service=webapi 'grep -c "handled: 5" /var/log/muskie.log'</pre>
</div>
</div>
<div class="paragraph">
<p>Since the real-time logs only store the current hour&#8217;s data, at 01:02Z, this
would only scan 2 minutes worth of data.  At 01:58Z, this would scan 58 minutes
worth of data.</p>
</div>
<div class="paragraph">
<p>If we were looking for a specific request that took place at 01:37Z, then we&#8217;d
look at the real-time log file immediately after the request happened until
02:00Z (i.e., for 23 minutes).  After that, we&#8217;d have to look at the historical
logs.</p>
</div>
<div class="paragraph">
<p><strong>Historical logs</strong> are maintained by rotating the real-time logs at the top of
each hour and then uploading them into Manta.  Once in Manta, they&#8217;re stored
under:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/poseidon/stor/logs/COMPONENT/YYYY/MM/DD/HH/SHORTZONE.log</pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>COMPONENT</code> varies based on the component you&#8217;re looking for</p>
</li>
<li>
<p><code>YYYY</code>, <code>MM</code>, <code>DD</code>, and <code>HH</code> represent the year, month, day, and hour for the
entries in the log file</p>
</li>
<li>
<p><code>SHORTZONE</code> is the first 8 characters of the zone&#8217;s uuid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to find the load balancer (haproxy) logs from zone
f6817865-10fb-416c-a079-47941ac2aab4 from 2018-12-05T01:37Z, we would look for
the object:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/poseidon/stor/logs/haproxy/2018/12/05/01/f6817865.log</pre>
</div>
</div>
<div class="paragraph">
<p>You can scan a number of these logs at once using a compute job.  For example,
you could look for requests from IP address 10.1.2.3 in all of the load
balancer logs from December 5, 2018 using:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mfind -t o /poseidon/stor/logs/haproxy/2018/12/05 |
    mjob create -o -m 'grep 10.1.2.3'</pre>
</div>
</div>
<div class="paragraph">
<p>You can adjust the <code>mfind</code> invocation as needed to scan a broader or more narrow
range.  You could also use the <code>-n</code> argument to <code>mfind</code> to select log files from
a particular load balancer:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mfind -n f6817865.log -t o /poseidon/stor/logs/haproxy/2018/12/05 |
    mjob create -o -m 'grep 10.1.2.3'</pre>
</div>
</div>
<div class="paragraph">
<p>When working with a Manta deployment where jobs aren&#8217;t functional, you can
instead <code>mget</code> log files and do your filtering locally, like so:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mfind -t o /poseidon/stor/logs/haproxy/2018/12/05 |
    while read f; do mget $f | grep 10.1.2.3; done</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the above sequence of commands will download the entirety of every log
file found by <code>mfind</code>, which may occupy an inconvenient amount of time and disk
space. To mitigate this, you can use <code>head</code> to fetch a smaller number of log
entries, like so:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mfind -t o /poseidon/stor/logs/haproxy/2018/12/05 |
    while read f; do mget $f | head -n 1000 | grep 10.1.2.3; done</pre>
</div>
</div>
<div class="paragraph">
<p>When the above command sequence is run, each invocation of <code>mget</code> will terminate
once <code>head</code> has read 1000 lines.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> the archival process for historical logs first rotates the logs to new
files under <code>/var/log/manta/upload</code>.  A few minutes later, these are uploaded to
Manta and then removed from the local filesystem.  If the upload fails, the
files are kept in <code>/var/log/manta/upload</code> for up to two days.  In extreme
situations where Manta has been down for over an hour, you may find recent
historical log files in <code>/var/log/manta/upload</code>, and you can scan them similar
to the live log files using <code>manta-oneach</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_a_muskie_log_entry">Understanding a Muskie log entry</h3>
<div class="paragraph">
<p>Muskie (the Manta API server) logs an <em>audit</em> entry for every request that it
completes.  These logs are useful for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>understanding how Manta handled a particular request (e.g., how long did it
take?  where was the time spent?  what metadata shards were involved?  what
storage nodes were involved?  what errors were encountered?)</p>
</li>
<li>
<p>understanding the workload Manta is serving (e.g., what percentage of requests
are GETs?  what percentage are failing?  what&#8217;s the distribution of sizes for
uploaded objects?  which accounts are making the most requests?)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that for real-time incident response, it&#8217;s often faster to start with
<a href="#_checking_recent_historical_metrics">Checking recent historical metrics</a>.  These logs are most useful for digging
deeper into a particular request or the workload overall.</p>
</div>
<div class="paragraph">
<p>Muskie logs in <a href="https://github.com/trentm/node-bunyan">bunyan</a> format, which is a
JSON-based format.  You typically use the <code>bunyan</code> tool to view them.  You can
also use the <code>json</code> tool to filter and aggregate them.</p>
</div>
<div class="paragraph">
<p><strong>For more information, see <a href="#_muskie_log_entry_properties">Muskie log entry properties</a>.</strong></p>
</div>
<div class="sect3">
<h4 id="_contents_of_a_get_log_entry">Contents of a GET log entry</h4>
<div class="paragraph">
<p>Below is an example log entry for a <strong>GET request</strong>, formatted using the <code>bunyan</code>
command-line tool.  See <a href="#_muskie_log_entry_properties">Muskie log entry properties</a> for more details.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[2017-08-01T03:03:13.985Z]  INFO: muskie/HttpServer/79465 on 204ac483-7e7e-4083-9ea2-c9ea22f459fd: handled: 200 (audit=true, _audit=true, operation=getstorage, billable_operation=LIST, logicalRemoteAddress=172.27.4.22, remoteAddress=127.0.0.1, remotePort=64628, reqHeaderLength=754, resHeaderLength=269, err=false, latency=26, entryShard=tcp://3.moray.staging.joyent.us:2020, route=getstorage, req.owner=4d649f41-cf87-ca1d-c2c0-bb6a9004311d)
    GET /poseidon/stor/manta_gc/mako/1.stor.staging.joyent.us?limit=1024 HTTP/1.1
    accept: */*
    x-request-id: a080d88b-8e42-4a98-a6ec-12e1b0dbf612
    date: Tue, 01 Aug 2017 03:03:13 GMT
    authorization: Signature keyId="/poseidon/keys/ef:0e:27:45:c5:95:4e:92:ba:ab:03:17:e5:3a:60:14",algorithm="rsa-sha256",headers="date",signature="Q74o9RHIwrDT15ogL2WeB/jankUIqJAtMM5t7+VzrHxzoB52/BoqEnq9uMY0wEvPJxv+Lf1VyLG/IBXCXeUx+fZlkhKWIWd2jkpLRdVLKwZ4nnqTfHM+YXhZ0vSN1X1W2demmnpPRTRK/RaG21pyvlbIrSTwI+N5MtKFDh9/4Ks43wSyM4MvqZZWywfs7LgKz7UtjL1Z+juhJDT8mrfQYCDpZw/NDhHmoslKsMFesMrMjPALy/CBSB23800+MhLiFB7LT0nTyCLonPBmIOjrQCZu99ICXbCxx096XCzZ2XBOK1Pe4eoDUHWx5ukTbCJV63QA+gvcvDCbS5BdDn0Xiw=="
    user-agent: restify/1.4.1 (ia32-sunos; v8/3.14.5.9; OpenSSL/1.0.1i) node/0.10.32
    accept-version: ~1.0
    host: manta.staging.joyent.us
    connection: keep-alive
    x-forwarded-for: ::ffff:172.27.4.22
    --
    HTTP/1.1 200 OK
    last-modified: Sat, 22 Mar 2014 01:17:01 GMT
    content-type: application/x-json-stream; type=directory
    result-set-size: 1
    date: Tue, 01 Aug 2017 03:03:13 GMT
    server: Manta
    x-request-id: a080d88b-8e42-4a98-a6ec-12e1b0dbf612
    x-response-time: 26
    x-server-name: 204ac483-7e7e-4083-9ea2-c9ea22f459fd
    --
    req.caller: {
      "login": "poseidon",
      "uuid": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
      "groups": [
        "operators"
      ],
      "user": null
    }
    --
    req.timers: {
      "earlySetup": 32,
      "parseDate": 8,
      "parseQueryString": 28,
      "handler-3": 127,
      "checkIfPresigned": 3,
      "enforceSSL": 3,
      "ensureDependencies": 5,
      "_authSetup": 5,
      "preSignedUrl": 3,
      "checkAuthzScheme": 4,
      "parseAuthTokenHandler": 36,
      "signatureHandler": 73,
      "parseKeyId": 59,
      "loadCaller": 133,
      "verifySignature": 483,
      "parseHttpAuthToken": 5,
      "loadOwner": 268,
      "getActiveRoles": 43,
      "gatherContext": 27,
      "setup": 225,
      "getMetadata": 5790,
      "storageContext": 8,
      "authorize": 157,
      "ensureEntryExists": 3,
      "assertMetadata": 3,
      "getDirectoryCount": 7903,
      "getDirectory": 10245
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The raw JSON, formatted with the <code>json</code> tool, looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "name": "muskie",
  "hostname": "204ac483-7e7e-4083-9ea2-c9ea22f459fd",
  "pid": 79465,
  "component": "HttpServer",
  "audit": true,
  "level": 30,
  "_audit": true,
  "operation": "getstorage",
  "billable_operation": "LIST",
  "logicalRemoteAddress": "172.27.4.22",
  "remoteAddress": "127.0.0.1",
  "remotePort": 64628,
  "reqHeaderLength": 754,
  "req": {
    "method": "GET",
    "url": "/poseidon/stor/manta_gc/mako/1.stor.staging.joyent.us?limit=1024",
    "headers": {
      "accept": "*/*",
      "x-request-id": "a080d88b-8e42-4a98-a6ec-12e1b0dbf612",
      "date": "Tue, 01 Aug 2017 03:03:13 GMT",
      "authorization": "Signature keyId=\"/poseidon/keys/ef:0e:27:45:c5:95:4e:92:ba:ab:03:17:e5:3a:60:14\",algorithm=\"rsa-sha256\",headers=\"date\",signature=\"Q74o9RHIwrDT15ogL2WeB/jankUIqJAtMM5t7+VzrHxzoB52/BoqEnq9uMY0wEvPJxv+Lf1VyLG/IBXCXeUx+fZlkhKWIWd2jkpLRdVLKwZ4nnqTfHM+YXhZ0vSN1X1W2demmnpPRTRK/RaG21pyvlbIrSTwI+N5MtKFDh9/4Ks43wSyM4MvqZZWywfs7LgKz7UtjL1Z+juhJDT8mrfQYCDpZw/NDhHmoslKsMFesMrMjPALy/CBSB23800+MhLiFB7LT0nTyCLonPBmIOjrQCZu99ICXbCxx096XCzZ2XBOK1Pe4eoDUHWx5ukTbCJV63QA+gvcvDCbS5BdDn0Xiw==\"",
      "user-agent": "restify/1.4.1 (ia32-sunos; v8/3.14.5.9; OpenSSL/1.0.1i) node/0.10.32",
      "accept-version": "~1.0",
      "host": "manta.staging.joyent.us",
      "connection": "keep-alive",
      "x-forwarded-for": "::ffff:172.27.4.22"
    },
    "httpVersion": "1.1",
    "owner": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
    "caller": {
      "login": "poseidon",
      "uuid": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
      "groups": [
        "operators"
      ],
      "user": null
    },
    "timers": {
      "earlySetup": 32,
      "parseDate": 8,
      "parseQueryString": 28,
      "handler-3": 127,
      "checkIfPresigned": 3,
      "enforceSSL": 3,
      "ensureDependencies": 5,
      "_authSetup": 5,
      "preSignedUrl": 3,
      "checkAuthzScheme": 4,
      "parseAuthTokenHandler": 36,
      "signatureHandler": 73,
      "parseKeyId": 59,
      "loadCaller": 133,
      "verifySignature": 483,
      "parseHttpAuthToken": 5,
      "loadOwner": 268,
      "getActiveRoles": 43,
      "gatherContext": 27,
      "setup": 225,
      "getMetadata": 5790,
      "storageContext": 8,
      "authorize": 157,
      "ensureEntryExists": 3,
      "assertMetadata": 3,
      "getDirectoryCount": 7903,
      "getDirectory": 10245
    }
  },
  "resHeaderLength": 269,
  "res": {
    "statusCode": 200,
    "headers": {
      "last-modified": "Sat, 22 Mar 2014 01:17:01 GMT",
      "content-type": "application/x-json-stream; type=directory",
      "result-set-size": 1,
      "date": "Tue, 01 Aug 2017 03:03:13 GMT",
      "server": "Manta",
      "x-request-id": "a080d88b-8e42-4a98-a6ec-12e1b0dbf612",
      "x-response-time": 26,
      "x-server-name": "204ac483-7e7e-4083-9ea2-c9ea22f459fd"
    }
  },
  "err": false,
  "latency": 26,
  "entryShard": "tcp://3.moray.staging.joyent.us:2020",
  "route": "getstorage",
  "msg": "handled: 200",
  "time": "2017-08-01T03:03:13.985Z",
  "v": 0
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_contents_of_a_put_log_entry">Contents of a PUT log entry</h4>
<div class="paragraph">
<p>Below is an example log entry for a <strong>GET request</strong>, formatted using the <code>json</code>
tool.  See <a href="#_muskie_log_entry_properties">Muskie log entry properties</a> for more details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "name": "muskie",
  "hostname": "204ac483-7e7e-4083-9ea2-c9ea22f459fd",
  "pid": 79465,
  "component": "HttpServer",
  "audit": true,
  "level": 30,
  "_audit": true,
  "operation": "putdirectory",
  "billable_operation": "PUT",
  "logicalRemoteAddress": "172.27.3.22",
  "reqHeaderLength": 655,
  "req": {
    "method": "PUT",
    "url": "/poseidon/stor/logs/config-agent/2017/08/01/02",
    "headers": {
      "user-agent": "curl/7.37.0",
      "host": "manta.staging.joyent.us",
      "accept": "*/*",
      "date": "Tue, 01 Aug 2017 03:01:10 GMT",
      "authorization": "Signature keyId=\"/poseidon/keys/ef:0e:27:45:c5:95:4e:92:ba:ab:03:17:e5:3a:60:14\",algorithm=\"rsa-sha256\",signature=\"VkRkcUK7Y796whM3/IsAl+wVvsu9pKwVGNHIHxLqeBtJZqrR+cbgWZ/E9uchhsxsMezvVXVN7hMXhiSxlfnGJKjPoTKJzfJNSW8WEUhu7rMilRi9WkYGvxo/PpdplK0/Evx1dvxHSX2TiAoTgBs5s6IyP7j6LgySfDu6TzJu/9HJdLzIwAf/TTiHU15okOUoJGbcNb+OcGN/mp+EZpYbNbJ8+I585v1ZLTuta1eAPngUPWp5E7Vm5sUpJH87/8bx2H/3HaMB9YCCacorZ7NkVS5Mbiaz0ptYYEESj8DCJScKnEVrM/L97zGuTPOnQ38Il/CZfENAP7ZH2u029h3WSg==\"",
      "connection": "close",
      "content-type": "application/json; type=directory",
      "x-forwarded-for": "::ffff:172.27.3.22"
    },
    "httpVersion": "1.1",
    "owner": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
    "caller": {
      "login": "poseidon",
      "uuid": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
      "groups": [
        "operators"
      ],
      "user": null
    },
    "timers": {
      "earlySetup": 94,
      "parseDate": 45,
      "parseQueryString": 32,
      "handler-3": 268,
      "checkIfPresigned": 8,
      "enforceSSL": 7,
      "ensureDependencies": 9,
      "_authSetup": 10,
      "preSignedUrl": 7,
      "checkAuthzScheme": 8,
      "parseAuthTokenHandler": 78,
      "signatureHandler": 155,
      "parseKeyId": 166,
      "loadCaller": 346,
      "verifySignature": 1164,
      "parseHttpAuthToken": 12,
      "loadOwner": 234,
      "getActiveRoles": 43,
      "gatherContext": 28,
      "setup": 315,
      "getMetadata": 13345,
      "storageContext": 14,
      "authorize": 409,
      "ensureParent": 222,
      "mkdir": 841
    }
  },
  "resHeaderLength": 215,
  "res": {
    "statusCode": 204,
    "headers": {
      "connection": "close",
      "last-modified": "Tue, 01 Aug 2017 03:01:01 GMT",
      "date": "Tue, 01 Aug 2017 03:01:11 GMT",
      "server": "Manta",
      "x-request-id": "ac2a5780-7665-11e7-b9e8-cf86a4bf1253",
      "x-response-time": 18,
      "x-server-name": "204ac483-7e7e-4083-9ea2-c9ea22f459fd"
    }
  },
  "latency": 18,
  "entryShard": "tcp://3.moray.staging.joyent.us:2020",
  "parentShard": "tcp://2.moray.staging.joyent.us:2020",
  "route": "putdirectory",
  "msg": "handled: 204",
  "time": "2017-08-01T03:01:11.048Z",
  "v": 0
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_latency_for_a_specific_request">Understanding latency for a specific request</h3>

</div>
<div class="sect2">
<h3 id="_finding_a_load_balancer_log_entry">Finding a load balancer log entry</h3>
<div class="sect3">
<h4 id="_when_to_investigate_the_load_balancer">When to investigate the load balancer</h4>
<div class="paragraph">
<p>All HTTP requests to Manta travel through an haproxy-based load balancer (in a
component sometimes called "muppet") before reaching the Manta API ("webapi" or
"muskie").  This load balancer is one of the first components that processes
these requests when they arrive at Manta.  For many problems internal to Manta,
it&#8217;s more useful to look at <a href="#_understanding_a_muskie_log_entry">log entries at
Muskie (webapi)</a>.  However, there are a several cases where it&#8217;s helpful to investigate the load balancer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when investigating a problem where the client reports <em>not</em> having received a
normal HTTP response (e.g., a "connection refused", "connection reset", or a
connection timeout)</p>
</li>
<li>
<p>when investigating a problem where the client reports having received a
500-level error with no "x-server-name" header.  (This generally indicates the
response was sent by the load balancer, which happens when Muskie sends an
invalid response or fails to send a response within a given timeout.)</p>
</li>
<li>
<p>when investigating a problem where Muskie reports surprising client behavior
(e.g., client closed its connection mid-upload, or Muskie timed out waiting
for a client to either upload or download data)</p>
</li>
<li>
<p>when investigating a failed request for which there appears to be no Muskie
log entry at all</p>
</li>
<li>
<p>to identify the source IP address of a client in a case where Muskie fails to
report that in its own log entry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, if a client receives a well-formed response from Manta, the Muskie
logs have more useful information than the load balancer logs.  In these other
cases where either the client or Muskie is doing something surprising, the load
balancer log entries can provide more information about exactly what happened.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a major caveat to the load balancer logs: <strong>haproxy is only able to
interpret HTTP-level information about the first request on each TCP
connection.</strong>  For clients using HTTP keep-alive, where multiple HTTP requests
are sent sequentially over a TCP connection, you may not find information in the
haproxy logs about requests after the first one.</p>
</div>
</div>
<div class="sect3">
<h4 id="_finding_load_balancer_log_entries">Finding load balancer log entries</h4>
<div class="paragraph">
<p>First, see <a href="#_locating_log_files">Locating log files</a> for information on where to find real-time
and historical log files.  For the load balancer, real-time log files are stored
in <code>/var/log/haproxy.log</code>.  Historical log files are stored in Manta under
<code>/poseidon/stor/logs/haproxy</code>.</p>
</div>
<div class="paragraph">
<p>Usually when you&#8217;re looking for a load balancer log entry, you know one or more
of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an approximate time of the request (almost always necessary)</p>
</li>
<li>
<p>the URL that was requested</p>
</li>
<li>
<p>the remote IP address that made the request</p>
</li>
<li>
<p>the status code that was returned</p>
</li>
<li>
<p>that the request experienced an unusual HTTP exchange (e.g., a malformed
server response, a client timeout, or a server timeout)</p>
</li>
<li>
<p>the particular load balancer that handled the request</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since these are plaintext logs, you can use <code>grep</code> or <code>awk</code> to filter or
summarize them.  See <a href="#_understanding_a_load_balancer_log_entry">Understanding a load balancer log entry</a> for more.</p>
</div>
<div class="paragraph">
<p>Often you don&#8217;t know which load balancer handled a particular request.  In
that case, you need to scan all of them for a given time.  That might involve
<code>manta-oneach</code> or a compute job.  Again, see <a href="#_locating_log_files">Locating log files</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_a_load_balancer_log_entry">Understanding a load balancer log entry</h3>
<div class="paragraph">
<p>The load balancer logs in a plaintext format described in the
<a href="https://github.com/joyent/haproxy-1.5/blob/master/doc/haproxy-en.txt">haproxy
documentation</a>.  (The haproxy documentation is also plaintext so it&#8217;s not
possible to link directly to the right section, but look for the section called
"Log format".)  Our load balancer logs these through syslog, which prepends a
few fields.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example entry from our load balancer logs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2018-12-05T18:32:01+00:00 42563f8d-4d61-4045-ab87-c71560388399 haproxy[65158]: ::ffff:72.2.115.97:42121 [05/Dec/2018:18:30:01.859] https secure_api/be6 2/0/0/-1/120005 502 245 - - SH-- 247/192/240/19/0 0/0 "GET /thoth/stor/thoth?limit=1024 HTTP/1.1"</pre>
</div>
</div>
<div class="paragraph">
<p>We have a tool called <a href="https://github.com/joyent/node-haproxy-log">haplog</a> for
converting our haproxy log entries into JSON.  Often, the easiest way to filter
and summarize these log entries is to pass the log through <code>haplog</code>, use <code>json</code>
to extract the relevant fields, and then use <code>grep</code> or <code>awk</code> to summarize.  We
can use it like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ haplog 42563f8d.log | json
...
{
  "syslog_date": "2018-12-05T18:32:01.000Z",
  "syslog_hostname": "42563f8d-4d61-4045-ab87-c71560388399",
  "pid": 65158,
  "client_ip": "72.2.115.97",
  "client_port": 42121,
  "accept_date": "05/Dec/2018:18:30:01.859",
  "frontend_name": "https",
  "backend_name": "secure_api",
  "server_name": "be6",
  "Tq": 2,
  "Tw": 0,
  "Tc": 0,
  "Tr": -1,
  "Tt": 120005,
  "status_code": 502,
  "bytes_read": 245,
  "termination_state": {
    "raw": "SH--",
    "termination_cause": "BACKEND_ABORT",
    "state_at_close": "WAITING_FOR_RESPONSE_HEADERS",
    "persistence_cookie_client": "N/A",
    "persistence_cookie_server": "N/A"
  },
  "actconn": 247,
  "feconn": 192,
  "beconn": 240,
  "srv_conn": 19,
  "retries": 0,
  "srv_queue": 0,
  "backend_queue": 0,
  "http_request": "GET /thoth/stor/thoth?limit=1024 HTTP/1.1"
}</pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s quite a lot of information here!  Among the most relevant bits:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">haplog JSON field name</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"2018-12-05T18:32:01.000Z"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>syslog_date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timestamp when this entry was logged.  This usually corresponds to the end
of an HTTP request or TCP connection.  This is very useful for constructing
timelines of what happened.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"42563f8d-4d61-4045-ab87-c71560388399"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>syslog_hostname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On our systems, this is the zonename of the particular load balancer that
handled this request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"72.2.115.97"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>client_ip</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The (remote) IP address of the client that connected to Manta.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"05/Dec/2018:18:30:01.859"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>accept_date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timestamp when the TCP connection was accepted by the load balancer.  This
is very useful for constructing timelines of what happened.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"be6"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>server_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On our system, this is a unique identifier that indicates which Muskie zone
handled this request.  This identifier varies between load balancer zones and
over time.  In order to know which Muskie zone this corresponds to, you need to
find the corresponding line in the haproxy log file (at
<code>/opt/smartdc/muppet/etc/haproxy.cfg</code>).  This will contain the IP address of the
Muskie zone that handled the request.  This is useful for understanding the flow
of the request through Manta.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"SH--"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>termination_state</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a four-digit code that describes how the TCP session finally
terminated.  <strong>This is among the most useful fields for understanding abnormal
behavior from the client or Muskie.</strong>  This code can be used to tell whether the
client or server either did something unexpected (like closed the TCP
connection) or stopped responding.  For details, on what each code means, see
the haproxy documentation linked above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"GET /thoth/stor/thoth?limit=1024 HTTP/1.1"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>http_request</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first line of the HTTP request, which contains the HTTP method and request
URL.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are a few telltale symptoms here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The elapsed time between <code>accept_date</code> and <code>syslog_date</code> is exactly two
minutes.  The load balancer has a two-minute timeout for Muskie responding to
requests.</p>
</li>
<li>
<p>The termination status <code>SH--</code> is documented (in the haproxy docs) to mean:</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>SH    The server aborted before sending its full headers, or it crashed.</p>
</div>
</blockquote>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This entry appears to reflect Muskie closing its TCP connection (without sending
an HTTP response) after exactly two minutes.  If we didn&#8217;t know what happened
here, we at least know now that Muskie did something unexpected and not the
client, and we also know which Muskie zone it was.</p>
</div>
</div>
<div class="sect2">
<h3 id="_build_a_request_timeline">Build a request timeline</h3>

</div>
<div class="sect2">
<h3 id="_details_about_specific_error_messages">Details about specific error messages</h3>
<div class="sect3">
<h4 id="__code_no_storage_nodes_available_for_this_request_code"><code>No storage nodes available for this request</code></h4>

</div>
<div class="sect3">
<h4 id="__code_not_enough_free_space_for_mb_code"><code>Not enough free space for ... MB</code></h4>
<div class="paragraph">
<p>This code (associated with 507 errors) indicates that Manta does not have enough
space available on any storage nodes for the write <em>that was requested</em>.  This
would be surprising in production environments, although it&#8217;s easy to induce
even in production by requesting an absurd size.  For example, you&#8217;ll see this
if you attempt to upload an enormous object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">$ mput -H 'max-content-length: 1125899906842624' /dap/stor/waytoobig
mput: NotEnoughSpaceError: not enough free space for 1073741824 MB</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://apidocs.joyent.com/manta/api.html#PutObject">Recall that Manta supports
two kinds of uploads</a>: streaming and fixed-length.</p>
</div>
<div class="paragraph">
<p>Streaming uploads are specified using the <code>transfer-encoding: chunked</code> header.
In this case, the space allocated up front (and validated) is specified by the
<code>max-content-length</code> header.  If that header is missing, a default value is used
<em>that is sometimes too large in some development environments</em>, which can cause
streaming uploads to fail in development environments.</p>
</div>
<div class="paragraph">
<p>If an object PUT does not specify <code>transfer-encoding: chunked</code>, then it must
specify <code>content-length</code>, in which case that value is used for allocation (and
validation).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_locating_metadata_for_an_object">Locating metadata for an object</h3>
<div class="paragraph">
<p>See <a href="http://joyent.github.io/manta/#locating-object-data">Locating object data</a> in
the Manta Operator&#8217;s Guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_locating_actual_data_for_an_object">Locating actual data for an object</h3>
<div class="paragraph">
<p>See <a href="http://joyent.github.io/manta/#locating-object-data">Locating object data</a> in
the Manta Operator&#8217;s Guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_locating_a_particular_server">Locating a particular server</h3>
<div class="paragraph">
<p>See <a href="http://joyent.github.io/manta/#locating-servers">Locating servers</a> in the
Manta Operator&#8217;s Guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_locating_a_particular_zone">Locating a particular zone</h3>
<div class="paragraph">
<p>See <a href="http://joyent.github.io/manta/#locating-manta-component-zones">Locating Manta
component zones</a> in the Manta Operator&#8217;s Guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_locating_a_particular_database_shard">Locating a particular database shard</h3>

</div>
<div class="sect2">
<h3 id="_finding_what_shard_a_particular_zone_is_part_of">Finding what shard a particular zone is part of</h3>

</div>
<div class="sect2">
<h3 id="_save_debugging_state_and_restart_a_process">Save debugging state and restart a process</h3>

</div>
<div class="sect2">
<h3 id="_investigating_service_discovery">Investigating service discovery</h3>

</div>
<div class="sect2">
<h3 id="_investigating_a_slow_process">Investigating a slow process</h3>

</div>
<div class="sect2">
<h3 id="_investigating_why_a_process_is_on_cpu">Investigating why a process is on-CPU</h3>

</div>
<div class="sect2">
<h3 id="_investigating_why_a_process_is_off_cpu">Investigating why a process is off-CPU</h3>

</div>
<div class="sect2">
<h3 id="_check_for_a_garbage_collection_issue_or_memory_leak">Check for a garbage collection issue (or memory leak)</h3>

</div>
<div class="sect2">
<h3 id="_scaling_up_a_component">Scaling up a component</h3>

</div>
<div class="sect2">
<h3 id="_characterizing_a_problem">Characterizing a problem</h3>
<div class="paragraph">
<p>It&#8217;s very valuable to <em>briefly</em> and <em>precisely</em> characterize a problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when asking for help from others, so they can quickly understand the relevant
context</p>
</li>
<li>
<p>for summarizing status to stakeholders</p>
</li>
<li>
<p>for handing off work to others (e.g., when escalating to another team or
changing shifts)</p>
</li>
<li>
<p>as a form of
<a href="https://en.wikipedia.org/wiki/Rubber_duck_debugging">rubber-ducking</a>&#8201;&#8212;&#8201;it
often helps spark insight</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When characterizing a problem, include the basic facts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exactly <strong>what</strong> you&#8217;ve observed: 500 errors? 503 errors? Elevated latency?
It&#8217;s useful to be as specific as you can (e.g., "a 5% increase in 500
errors"), but it&#8217;s better to be vague (e.g., "an increase in latency") than to
say something false (e.g., "an increase in average latency" when only tail
latency is affected).</p>
</li>
<li>
<p>Something about <strong>when</strong> the observations started.  Again, it&#8217;s useful to be
as specific as possible (e.g., "starting at 2018-08-09T16:47Z"), but it&#8217;s
better to be vague (e.g., "seems to have increased since yesterday") than
incorrect (e.g., "it&#8217;s higher than yesterday" when you&#8217;re really just
eyeballing an average value from a graph).</p>
</li>
<li>
<p>What other observations you&#8217;ve made (or anything else you&#8217;ve tried, and the
results)</p>
</li>
<li>
<p>(if you&#8217;re asking for help) Any specific questions you have.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s useful to mention what conclusions you&#8217;ve drawn, but try to distinguish
facts (e.g., "moray queue lengths are high") from inferences ("moray is
overloaded").</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a good status summary:</p>
</div>
<div class="quoteblock">
<blockquote>
Webapi is reporting an increase in 500 and 503 errors since 2018-08-09T16:58Z.
These do not seem correlated with increased latency, nor with any errors from
the metadata tier.  How do we check for errors from the storage tier?
</blockquote>
</div>
<div class="paragraph">
<p>It&#8217;s often very helpful to include screenshots
(<a href="https://support.apple.com/en-us/HT201361">MacOS instructions</a>).  Here&#8217;s an
example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/metrics-webapi-elevated-1.png" alt="Elevated latency at Webapi">
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s one way to characterize this:</p>
</div>
<div class="quoteblock">
<blockquote>
We saw elevated latency since early on 8/1 (UTC)
</blockquote>
</div>
<div class="paragraph">
<p>Better:</p>
</div>
<div class="quoteblock">
<blockquote>
We saw a modest increase in tail latency (both p90 and p99) starting early on
8/1 and continuing through 8/4 (UTC).  This was followed by a sharp, significant
increase on 8/6.
</blockquote>
</div>
<div class="paragraph">
<p>More detailed (may be better, depending on the situation):</p>
</div>
<div class="quoteblock">
<blockquote>
We saw a modest increase in tail latency (both p90 and p99) starting early on
8/1 and continuing through 8/4 (UTC).  This was followed by a sharp, significant
increase on 8/6.  During both increases, latency was much less stable than
before.  p90 peaked at about 50% higher than normal, while p95 spiked about 3x
what it was before.
</blockquote>
</div>
<div class="paragraph">
<p>Of course, it&#8217;s easy to give too much detail, too.  Think about what&#8217;s likely
to be relevant for your audience.</p>
</div>
<div class="paragraph">
<p><strong>Grafana&#8217;s features can help you make quantitative statements.</strong>  For example,
take this graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/metrics-webapi-bytes-1.png" alt="Dips in throughput at Webapi">
</div>
</div>
<div class="paragraph">
<p>About the dip on 8/6, you could say:</p>
</div>
<div class="quoteblock">
<blockquote>
We saw a dip in throughput on 8/6.
</blockquote>
</div>
<div class="paragraph">
<p>Better would be:</p>
</div>
<div class="quoteblock">
<blockquote>
There was a brief dip in inbound throughput on 8/6 around 12:36Z.
</blockquote>
</div>
<div class="paragraph">
<p>Since Grafana can show you both the average for the whole period, plus the value
at a point, you can make more specific statements:</p>
</div>
<div class="quoteblock">
<blockquote>
There was a brief dip in inbound throughput on 8/6 around 12:36Z.  It dropped
about 38% relative to the average for 14 days around it (3.3 GBps during the
dip, compared to a recent average of about 5.3 GBps).
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_references">Quick references</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_manta_http_quick_reference">Manta HTTP Quick Reference</h3>
<div class="sect3">
<h4 id="_http_status_codes_in_manta">HTTP Status Codes in Manta</h4>
<div class="paragraph">
<p>Related links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://tools.ietf.org/html/rfc7231#page-47">RFC 7231, Section 6</a>, which covers
HTTP response codes</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">List of HTTP Status
Codes</a> on Wikipedia</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here we cover only status codes with particular meanings within Manta or that are commonly used within Manta.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">HTTP</th>
<th class="tableblock halign-left valign-top">Meaning in Manta</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100-continue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client requested extra initial validation, and the server has not yet rejected the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most commonly used for successful GETs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">201</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Created</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most commonly used for creating jobs and multipart uploads (not object PUT operations)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">204</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>No Content</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used for successful direction creations, directory removals, object uploads, object deletes, snaplink creation, and a handful of other operations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bad Request</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client send an invalid HTTP request (e.g., an incorrect MD5 checksum)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Unauthorized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client sent an invalid or unsupported signature, or it did not send any signature.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">403</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Forbidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client failed to authenticate, or it authenticated and was not allowed to access the resource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">408</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Request Timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The server did not receive a complete request from the client within a reasonable timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">409</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Conflict</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client sent an invalid combination of parameters for an API request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">412</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Precondition Failed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client issued a conditional request and the conditions were not true.  (For example, this could have been a PUT-if-the-object-does-not-already-exist, and the object already existed.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">429</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Too Many Requests</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client is being rate-limited by the server because it issued too many requests in too short a period.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">499</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(not in HTTP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The 499 status is used to indicate that the client appeared to abandon the request.  (In this case, it&#8217;s not possible to send a response.  The 499 code is used for internal logging and statistics.)  This was originally used in nginx.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Internal Server Error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Catch-all code for a failure to process this request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">502</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bad Gateway</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Historically, this code was emitted by Manta when requests took more than two minutes to complete.  This was an artifact of the load balancer.  Modern versions of Manta report this as a 503.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">503</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Service Unavailable</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This code generally indicates that the system is overloaded and cannot process more work.  In practice, this currently means that a particular metadata shard&#8217;s queue is full, that Muskie took too long to respond to the request, or that there aren&#8217;t enough working storage nodes with enough disk space to satisfy this upload.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">504</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Gateway Timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to 502.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">507</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not Enough Space</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Manta deployment is out of physical disk space for new objects.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Generally:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Responses with status codes above 400 (400 through 599) are often called <strong>errors</strong>.  In many cases, though, 400-level errors do not indicate that anything is wrong.  For example, a 404 may be normal behavior for a client that checks for the existence of a particular object before doing some other operation.</p>
</li>
<li>
<p>For errors (except for 499), the response body should contain a JSON object containing more information: a Manta-specific error code and message.</p>
</li>
<li>
<p>Generally, <strong>400-level codes (i.e., codes from 400 to 499)</strong> indicate that the request failed due to something within the client&#8217;s control.</p>
</li>
<li>
<p>Generally, <strong>500-level codes (i.e., codes from 500 to 599)</strong> indicate a server-side failure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also: <a href="#_investigating_an_increase_in_error_rate">Investigating an increase in error rate</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_http_headers_in_manta">HTTP Headers in Manta</h4>
<div class="paragraph">
<p>Related links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">List of HTTP Header Fields</a> on Wikipedia</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here we cover only headers with particular meanings within Manta or that are commonly used within Manta.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Header</th>
<th class="tableblock halign-left valign-top">Request/Response</th>
<th class="tableblock halign-left valign-top">Origin</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#_streaming_vs_fixed_size_requests">Streaming vs. fixed-size requests</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-MD5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MD5 checksum of the body of a request or response.  It&#8217;s essential that clients and servers validate this on receipt.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP, Manta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes the type (i.e., MIME type) of the body of the request or response.  Manta understands a special content-type for directories called <code>application/json; type=directory</code>, which represents a Manta directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time when the request or response was generated.  This is often useful when debugging for putting together a timeline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Transfer-encoding: chunked</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <a href="#_streaming_vs_fixed_size_requests">Streaming vs. fixed-size requests</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">any header starting with <code>m-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary user-provided headers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Result-Set-Size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For GET or HEAD requests on directories, this header indicates how many items are in the directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-request-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unique identifier for this request.  This can be used to locate details about a request in Matna logs.  Clients may specify this header on requests, in which case Manta will use the requested id.  Othewrise, Manta will generate one and provide it with the response.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-server-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unique identifier for the frontend instance that handled this request.  Specifically, this identifies the "webapi" zone that handled the request.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_requests_using_100_continue">Requests using "100-continue"</h4>
<div class="paragraph">
<p>HTTP allows clients to specify a header called <code>Expect: 100-continue</code> to request that the server validate the request headers before the client sends the rest of it.  For example, suppose a client wants to upload a 10 GiB object to <code>/foo/stor/bar/obj1</code>, but <code>/foo/stor/bar</code> does not exist.  With <code>Expect: 100-continue</code>, the server can immediately send a "404 Not Found" response (because the parent directory doesn&#8217;t exist).  Without this header, HTTP would require that the client send the entire 10 GiB request.</p>
</div>
<div class="paragraph">
<p>When <code>Expect: 100-continue</code> is specified with the request headers, then the client waits for a <code>100-continue</code> response before proceeding to send the body of the request.</p>
</div>
<div class="paragraph">
<p>We mention this behavior because error handling for requests that do <em>not</em> use <code>100-continue</code> can be surprising.  For example, when the client doesn&#8217;t specify this header, the server might still choose to send a 400 or 500-level response immediately, but it must still wait for the client to send the whole request.  There have been bugs in the past where the server did not read the request of the request, resulting in a memory leak and a timeout from the client&#8217;s perspective (because the client has no reason to read a response before it has even finished sending the request, if it didn&#8217;t use <code>100-continue</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_streaming_vs_fixed_size_requests">Streaming vs. fixed-size requests</h4>
<div class="paragraph">
<p>In order to frame HTTP requests and responses, one of two modes must be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A request or response can specify a <code>content-length</code> header that indicates
exactly how many bytes of data will be contained in the body; or</p>
</li>
<li>
<p>A request or response can specify <code>transfer-encoding: chunked</code>, which
indicates that the body will be sent in chunks, each of which is preceded by
a size</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://apidocs.joyent.com/manta/api.html#PutObject">Manta treats these two modes a little differently</a>.  If an upload request has a <code>content-length</code>, then Manta ensures that the storage nodes chosen to store the data have enough physical space available.  Requests with <code>transfer-encoding: chunked</code> are called <em>streaming uploads</em>.  For these uploads, a maximum content length is assumed by the server that&#8217;s used to validate that storage nodes contain enough physical space.  <a href="https://apidocs.joyent.com/manta/api.html#PutObject">The maximum content length for a streaming upload can be overridden using the <code>max-content-length</code> header.</a></p>
</div>
<div class="paragraph">
<p>See also the next section on
<a href="#_validating_the_contents_of_requests_and_responses">Validating the contents of requests and responses</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_validating_the_contents_of_requests_and_responses">Validating the contents of requests and responses</h4>
<div class="paragraph">
<p><strong>It&#8217;s critical that clients and servers validate the body of responses and requests.  Some types of corruption are impossible to report any other way.</strong></p>
</div>
<div class="paragraph">
<p>Corrupted requests and responses can manifest in a number of ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the sender may stop sending after too few bytes</p>
</li>
<li>
<p>the sender may send EOF after sending too few bytes</p>
</li>
<li>
<p>the sender may send too many bytes</p>
</li>
<li>
<p>the body may have the right number of bytes, but have incorrect bytes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Importantly, because of the two modes of transfer described above (under <a href="#_streaming_vs_fixed_size_requests">Streaming vs. fixed-size requests</a>), the reader of a request or response always knows how many bytes to expect.  In the cases above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the sender stops sending bytes after too few bytes (but the socket is still open for writes in both directions), then the reader will fail the operation due to a timeout.  For example, if the client does this, then the server will report a 408 error.  <strong>The client must implement a timeout for this case to cover the case where the server fails in this way.</strong></p>
</li>
<li>
<p>If the sender sends EOF after too few bytes, this would be a bad request or response.  If a client did this, then the server would report a 400 error.  <strong>The client must implement a check for this case to cover the case where the server fails in this way.</strong>  At this point in the HTTP operation, the client may have already read a successful response (i.e., a 200), and it needs to be sophisticated enough to treat it as an error anyway.</p>
</li>
<li>
<p>If the sender sends too many bytes, then the request or response would be complete, but the <em>next</em> request or response would likely be invalid.</p>
</li>
<li>
<p>When possible, clients and servers should generally send a <code>Content-MD5</code> header.  This allows the remote side to compute an MD5 checksum on the body and verify that the correct bytes were sent.  For object downloads, Manta always stores the MD5 computed from the original upload and it always provides the <code>Content-MD5</code> header on responses.  If clients provide a <code>Content-MD5</code> header on uploads, then Manta always validates that it receives it.  When both of these mechanisms are used by both client and server, a client can be sure of end-to-end integrity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Note:</strong> It&#8217;s been noted that MD5 checksums are deprecated for security purposes due to the risk of collisions.  While they are likely not appropriate for security, MD5 collisions remain rare enough for MD5 checksums to be used for basic integrity checks.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_muskie_log_entry_properties">Muskie log entry properties</h3>
<div class="paragraph">
<p>Below is a summary of the most relevant fields for an audit log entry.  (Note
that Muskie sometimes writes out log entries unrelated to the completion of an
HTTP request.  Only log entries with <code>"audit": true</code> represent completion of an
HTTP request.  Other log entries have other fields.)</p>
</div>
<div class="sect3">
<h4 id="_general_muskie_provided_properties">General Muskie-provided properties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JSON property</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>audit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, this entry describes completion of an HTTP request.  Otherwise, this is some other type of log entry, and many of the fields below may not apply.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>latency</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time in milliseconds between when Muskie started processing this request and when the response <em>headers</em> were sent.  This is commonly called <em>time to first byte</em>.  See also <a href="#_build_a_request_timeline">building a request timeline</a>.  This should generally match the <code>x-response-time</code> response header.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>operation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getstorage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manta-defined token that describes the type of operation.  In this case, <code>getstorage</code> refers to an HTTP <code>GET</code> from a user&#8217;s <code>stor</code> directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See specific properties below.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object describing the incoming request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.method</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP method for this request (specified by the client)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"/poseidon/stor/manta_gc/mako/1.stor.staging.joyent.us?limit=1024"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL (path) provided for this request (specified by the client)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.headers</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "accept": "*/*",
    "x-request-id": "a080d88b-8e42-4a98-a6ec-12e1b0dbf612",
    "date": "Tue, 01 Aug 2017 03:03:13 GMT",
    "authorization": "Signature keyId=\"/poseidon/keys/ef:0e:27:45:c5:95:4e:92:ba:ab:03:17:e5:3a:60:14\",algorithm=\"rsa-sha256\",headers=\"date\",signature=\"...\"",
    "user-agent": "restify/1.4.1 (ia32-sunos; v8/3.14.5.9; OpenSSL/1.0.1i) node/0.10.32",
    "accept-version": "~1.0",
    "host": "manta.staging.joyent.us",
    "connection": "keep-alive",
    "x-forwarded-for": "::ffff:172.27.4.22"
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Headers provided with this request (specified by the client).  The <code>Date</code> header is particularly useful to note, as this usually reflects the timestamp (on the client) when the client generated the request.  This is useful when <a href="#_build_a_request_timeline">constructing a request timeline</a>.  In particular, problems with the network (timeouts and retransmissions) or queueing any time before Muskie starts processing the request can be identified using this header, provided that the client clock is not too far off from the server clock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.caller</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "login": "poseidon",
    "uuid": "4d649f41-cf87-ca1d-c2c0-bb6a9004311d",
    "groups": [ "operators" ],
    "user": null
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object describing the account making this request.  This is not the same as the owner!  Note that this can differ from the owner of the resource (<code>req.owner</code>).  That commonly happens when the caller uses operator privileges to access objects in someone else&#8217;s account or when any user makes an authenticated request to access public data in some other user&#8217;s account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.caller.login</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"poseidon"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For authenticated requests, the name of the account that made the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.caller.uuid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"4d649f41-cf87-ca1d-c2c0-bb6a9004311d"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For authenticated requests, the unique identifier for the account that made the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.caller.groups</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[ "operators" ]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For authenticated requests, a list of groups that the caller is part of.  Generally, the only interesting group is <code>"operators"</code>, which grants the caller privileges to read from and write to any account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.caller.user</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For authenticated requests <em>from a subuser of the account</em>, the name of the subuser account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.owner</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"4d649f41-cf87-ca1d-c2c0-bb6a9004311d"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier for the account that <em>owns</em> the requested resource.  This is generally the uuid of the account at the start of the URL (i.e., for a request of <code>"/poseidon/stor"</code>, this would be the uuid of the account <code>poseidon</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>res</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See specific properties below.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes the HTTP response sent by Muskie to the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>res.statusCode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_http_status_codes_in_manta">HTTP-level status code</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>res.headers</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "last-modified": "Sat, 22 Mar 2014 01:17:01 GMT",
    "content-type": "application/x-json-stream; type=directory",
    "result-set-size": 1,
    "date": "Tue, 01 Aug 2017 03:03:13 GMT",
    "server": "Manta",
    "x-request-id": "a080d88b-8e42-4a98-a6ec-12e1b0dbf612",
    "x-response-time": 26,
    "x-server-name": "204ac483-7e7e-4083-9ea2-c9ea22f459fd"
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Headers sent in the response from Muskie to the client.  Among the most useful is the <code>x-request-id</code> header, which should uniquely identify this request.  You can use this to correlate observations from the client or other parts of the system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"getstorage"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifies the name of the restify route that handled this request.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_muskie_provided_properties_for_debugging_only">Muskie-provided properties for debugging only</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JSON property</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryShard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"tcp://3.moray.staging.joyent.us:2020"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When present, this indicates the shard that was queried for the metadata for <code>req.url</code>.  Unfortunately, this field is not currently present when Muskie fails to fetch metadata, either because of a Moray failure or just because the metadata is missing (i.e., the path doesn&#8217;t exist).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>err</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error associated with this request, if any.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>objectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"bf54fb8a-6cb5-4683-8655-f9ad90b984d4"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When present, this is the unique identifier for the Manta object identified by <code>req.url</code> when the request was made.  This is helpful when trying to verify that a request fetched the exact object that you expect (and not another object that had the same name at the time).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parentShard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"tcp://2.moray.staging.joyent.us:2020"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When present, this indicates the shard that was queried for the metadata for the parent directory of <code>req.url</code>.  This is only present when the parent metadata was fetched (which is common for PUT requests, but not GET or DELETE requests).  Unfortunately, this field is not currently present when Muskie fails to fetch metadata, either because of a Moray failure or just because the metadata is missing (i.e., the path doesn&#8217;t exist).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logicalRemoteAddress</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"172.27.4.22"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The (remote) IP address of the client connected to Manta.  Note that clients aren&#8217;t connected directly to Muskie.  When using TLS ("https" URLs), clients connect to <code>stud</code> in the <code>loadbalancer</code> component.  Stud connects to <code>haproxy</code> in the same container.  <code>haproxy</code> in the load balancer container connects to another <code>haproxy</code> instance in the Muskie container.  That <code>haproxy</code> instance connects to a Muskie process.  The client&#8217;s IP is passed through this chain and recorded in <code>logicalRemoteAddress</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>remoteAddress</code>, <code>remotePort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"127.0.0.1"</code>, <code>64628</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The IP address and port of the TCP connection over which this request was received.  Generally, Muskie only connects directly to an <code>haproxy</code> inside the same zone, so the remote address will usually be <code>127.0.0.1</code>.  Neither of these fields is generally interesting except when debugging interactions with the local <code>haproxy</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>req.timers</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "earlySetup": 32,
    "parseDate": 8,
    "parseQueryString": 28,
    "handler-3": 127,
    "checkIfPresigned": 3,
    "enforceSSL": 3,
    "ensureDependencies": 5,
    "_authSetup": 5,
    "preSignedUrl": 3,
    "checkAuthzScheme": 4,
    "parseAuthTokenHandler": 36,
    "signatureHandler": 73,
    "parseKeyId": 59,
    "loadCaller": 133,
    "verifySignature": 483,
    "parseHttpAuthToken": 5,
    "loadOwner": 268,
    "getActiveRoles": 43,
    "gatherContext": 27,
    "setup": 225,
    "getMetadata": 5790,
    "storageContext": 8,
    "authorize": 157,
    "ensureEntryExists": 3,
    "assertMetadata": 3,
    "getDirectoryCount": 7903,
    "getDirectory": 10245
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An object describing the time in microseconds for each phase of the request processing pipeline.  This is useful for identifying latency.  The names in this object are the names of functions inside Muskie responsible for the corresponding phase of request processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sharksContacted</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">[ {
  "shark": "1.stor.staging.joyent.us",
  "result": "ok",
  "timeToFirstByte": 2,
  "timeTotal": 902,
  "_startTime": 1509505866032
}, {
  "shark": "2.stor.staging.joyent.us",
  "result": "ok",
  "timeToFirstByte": 1,
  "timeTotal": 870,
  "_startTime": 1509505866033
} ]</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This field should be present for Manta requests that make requests to individual storage nodes.  The value is an array of storage nodes contacted as part of the request, including the result of this subrequest, when it started, and how long it took.</p>
</div>
<div class="paragraph">
<p>For GET requests, these subrequests are GET requests from individual storage nodes hosting a copy of the object requested.  These subrequests happen serially, and we stop as soon as one completes.</p>
</div>
<div class="paragraph">
<p>For PUT requests, the storage node subrequests are PUT requests to individual storage nodes on which a copy of the new object will be stored.  If all goes well, you&#8217;ll see N sharks contacted (typically 2, but whatever the client&#8217;s requested durability level is), all successfully, and the requests will be concurrent with each other.  If any of these fail, Manta will try another N sharks, and up to one more set of N.  For durability level 2, you may see up to 6 sharks contacted: three sets of two.  The sets would be sequential, while each pair in a set run concurrently.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="__a_href_https_github_com_trentm_node_bunyan_core_fields_bunyan_a_provided_properties"><a href="https://github.com/trentm/node-bunyan#core-fields">Bunyan</a>-provided properties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JSON property</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"2017-08-01T03:03:13.985Z"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO 8601 timestamp closest to when the log entry was generated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hostname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"204ac483-7e7e-4083-9ea2-c9ea22f459fd"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hostname of the system that generated the log entry.  For us, this is generally a uuid corresponding to the zonename of the Muskie container.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>79465</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pid of the process that generated the log entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>level</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>30</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bunyan-defined log level.  This is a numeric value corresponding to conventional values like <code>'debug'</code>, <code>'info'</code>, <code>'warn'</code>, etc.  You can filter based on level using the <code>bunyan</code> command.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>msg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"handled: 200"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For Muskie audit log entries, the message is always <code>"handled: "</code> followed by the HTTP level status code.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>XXX talk about common stack traces?
XXX that should include 503 from <em>No storage nodes available for this request</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_tools_quick_reference">Debugging tools quick reference</h3>
<div class="paragraph">
<p>See also the <a href="https://github.com/joyent/manta-tools-deck">Manta Tools Overview</a>.</p>
</div>
<div class="paragraph">
<p>Many of these tools have manual pages or sections in this guide about how to use
them.  You can generally view the manual page with <code>man TOOLNAME</code> in whatever
context you can run the tool.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tool</th>
<th class="tableblock halign-left valign-top">Where you run it</th>
<th class="tableblock halign-left valign-top">Has manual page?</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manta-oneach(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headnode GZ or "manta" zones</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run arbitrary commands in various types of Manta zones</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>manta-login(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headnode GZ or "manta" zones</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open a shell in a particular Manta zone</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mlocate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"webapi" zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch metadata for an object (including what shard it&#8217;s on)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>moray(1)</code> tools</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"moray", "electric-moray" zones</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch rows directly from Moray</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>moraystat.d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"moray" zones</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows running stats about Moray RPC activity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/joyent/pgsqlstat"><code>pgsqlstat</code> tools</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"postgres" zones (<a href="https://jira.joyent.us/browse/MANATEE-364">need to be copied in as needed</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report on PostgreSQL activity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bunyan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format bunyan-format log files.  With <code>-p PID</code>, shows live verbose log entries from a process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>curl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>curl</code> is (among other things) a general-purpose HTTP client.  It can be used to make test requests to Manta itself as well as various components within Manta, including authcache and storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>proc(1)</code> tools (also called the <code>ptools</code>, which includes <code>pfiles</code>, <code>pstack</code>, and others)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inspect various properties of a process, including its open files, thread stacks, working directory, signal mask, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netstat(1M)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows information about the networking stack, including open TCP connections and various counters (including error counters).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>vfsstat(1M)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows running stats related to applications' use of the filesystem (e.g., reads and writes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>prstat(1M)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows running stats related to applications' use of CPU and memory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mpstat(1M)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows running stats related to system-wide CPU usage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>zonememstat(1M)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows running stats related to zone-wide memory usage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/joyent/mdb_v8/blob/master/docs/usage.md"><code>mdb_v8</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anywhere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inspect JavaScript-level state in core files from Node.js processes.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_glossary_of_jargon">Glossary of jargon</h3>
<div class="paragraph">
<p>See also: <a href="https://eng.joyent.com/ras/#_glossary">Glossary of hardware terms from
Joyent&#8217;s RAS specifications</a>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bounce (as in: "bounce a box", "bounce a service")</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Bouncing</em> a box or a service means restarting it.  Bouncing a box usually means rebooting a server.  Bouncing a service usually means restarting an SMF service (killing any running processes and allowing the system to restart them).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bound (as in: "CPU-bound", "disk-bound", "I/O-bound")</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A program or a workload is said to be <em>"X-bound"</em> for some resource X when its performance is limited by that resource.  For example, the performance of a CPU-bound process is limited by the amount of CPU available to it.  "Disk-bound" (or "I/O-bound") usually means that a process or workload is limited by the I/O performance of the storage subsystem, which may be a collection of disks organized into a ZFS pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">box</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <em>box</em> is a physical server (as opposed to a virtual machine or container).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">container/zone/VM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <em>container</em> is a lightweight virtualized environment, usually having its own process namespace, networking stack, filesystems, and so on.  For most purposes, a container looks like a complete instance of the operating system, but there may be many containers running within one instance of the OS.  They generally cannot interact with each other except through narrow channels like the network.  The illumos implementation of containers are called <em>zones</em>.  SmartOS also runs hardware-based virtual machines inside zones (i.e., a heavyweight hardware-virtualized environment <em>within</em> the lightweight OS-virtualized environment), and while those are technically running in a container, the term <em>container</em> is usually only applied to zones not running a hardware-based virtualization environment.  For historical reasons, within Triton and SmartOS, zones are sometimes called <em>VMs</em>, though that term sometimes refers only to the hardware virtualized variety.  The three terms are often used interchangeably (and also interchangeably with <em>instance</em>, since most components are deployed within their own container).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">headroom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Idle capacity for a resource.  For example, we say there&#8217;s CPU <em>headroom</em> on a box when some CPUs are idle some of the time.  This usually means the system is capable of doing more work (at least with respect to this resource).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">instance (general, SAPI)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like <em>service</em>, <em>instance</em> can refer to a number of different things, including a member of a SAPI service or SMF service.  Most commonly, "instance" to refer to a SAPI service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">latency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Latency</em> refers to how much time an operation takes.  It can apply to any discrete operation: a disk I/O request, a database transaction, a remote procedure call, a system call, establishment of a TCP connection, an HTTP request, and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">out of (as in: "out of CPU")</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We sometimes say a box is <em>out of</em> a resource when that resource is fully utilized (i.e., "out of CPU" when all CPUs are busy).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pegged, slammed, swamped</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are all synonyms for being <em>out of</em> some resource.  "The CPUs are pegged" means a box has very little CPU headroom (i.e., the CPUs are mostly fully utilized).  You can also say "one CPU is pegged" (i.e., that CPU is fully utilized).  You might also say "the disks are swamped" (i.e., they&#8217;re nearly always busy doing I/O).  See also <em>saturated</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">saturated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A resource is <em>saturated</em> when processes are failing to use the resource because it&#8217;s already fully utilized.  For example, when CPUs are saturated, threads that are ready to run have to wait in queues.  When a network port is saturated, packets are dropped.  Similar to <em>pegged</em>, but more precise.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service (general)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Service</em> can refer to a SAPI service (see below), an SMF service (see below), or it may be used more generally to describe almost any useful function provided by a software component.  As a verb (e.g., "this process is servicing requests"), it usually means "to process [requests]".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service (SAPI)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Within <a href="https://mo.joyent.com/docs/sapi/master/#overview">SAPI (the Triton facility for managing configuration and deployment of cloud applications like Manta)</a>, a <em>service</em> refers to a collection of instances providing similar functionality.  It usually describes a type of component (e.g., "storage" or "webapi") that may have many instances.  These instances usually share images and configuration, and within SAPI, the <em>service</em> is the place where such configuration is stored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service (SMF)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Within the operating system, an SMF <em>service</em> is a piece of configuration that usually describes long-running programs that should be automatically restarted under various failure conditions.  For example, we define an SMF service for "mahi-v2" (our authenticationc ache) so that the operating system automatically starts the service upon boot and restarts it if the process exits or dumps core.  (Within SMF, it&#8217;s actually <em>instances</em> of a service that get started, stopped, restarted, and so on.  For many services, there&#8217;s only one "default" instance, and the terms are often used interchangeably.  Usually someone will say "I restarted the mahi-v2 service" rather than "I restarted the sole instance of the mahi-v2 service".  However, for some services (notably "muskie", "moray", "electric-moray", and "binder") we do deploy multiple instances, and it may be important to be more precise (e.g., "three of the muskie instances in this zone are in maintenance").  See <code>smf(5)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">shard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <em>shard</em> generally refers to a database that makes up a fraction of a larger logical database.  For example, the Manta metadata tier is one logical data store, but it&#8217;s divided into a number of equally-sized shards.  In sharded systems like this, incoming requests are directed to individual shards in a deterministic way based on some <em>sharding key</em>.  (Many systems use a customer id for this purpose.  Manta traditionally uses the name of the parent directory of the resource requested.  In Manta, each shard typically uses 2-3 databases for high availability, but these aren&#8217;t separate shards because they&#8217;re exact copies.  Sharding typically refers to a collection of disjoint databases that together make up a much larger dataset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tail latency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When discussing a collection of operations, <em>tail latency</em> refers to the latency of the slowest operations (i.e., the <em>tail</em> of the distribution).  This is often quantified using a high-numbered <em>percentile</em>.  For example, if the 99th percentile of requests is 300ms, then 99% of requests have latency at most 300ms.  As compared with an average or median latency, the 99th percentile better summarizes the latency of the slowest requests.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment_specific_details">Deployment-specific details</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This documentation is general-purpose for any Manta deployment, but it makes
reference to specific infrastructure that operators should provide for their own
deployments.  In particular, it&#8217;s strongly recommended that operators deploy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one or more Prometheus instances to pull runtime metrics from various Manta
components, with rules defined to precompute commonly-used metrics</p>
</li>
<li>
<p>one or more Grafana instances to support dashboards based on these runtime
metrics</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We recommend creating a few different dashboards:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a "basic health" dashboard that shows:</p>
<div class="ulist">
<ul>
<li>
<p>webapi requests completed with ability to break out by operation and status
code</p>
</li>
<li>
<p>webapi inbound and outbound throughput</p>
</li>
<li>
<p>webapi average, p90, p95, and p99 latency</p>
</li>
<li>
<p>electric-moray average, p90, p95, and p99 latency</p>
</li>
<li>
<p>moray average, p90 p95, and p99 latency</p>
</li>
</ul>
</div>
</li>
<li>
<p>a "shard health" dashboard that shows:</p>
<div class="ulist">
<ul>
<li>
<p>moray RPCs per second with ability to break out by shard and RPC type</p>
</li>
<li>
<p>moray RPC average, p90, p95, and p99 latency</p>
</li>
</ul>
</div>
</li>
<li>
<p>a "postgres" dashboard that shows:</p>
<div class="ulist">
<ul>
<li>
<p>transactions committed and rolled back with ability to break out by shard</p>
</li>
<li>
<p>transactions-til-wraparound-autovacuum, with ability to break out by shard
and table</p>
</li>
<li>
<p>live and dead tuples, with ability to break out by shard and table</p>
</li>
<li>
<p>the fraction of dead tuples to total tuples</p>
</li>
</ul>
</div>
</li>
<li>
<p>a CPU utilization dashboard that shows</p>
<div class="ulist">
<ul>
<li>
<p>line graphs for each service showing the min and max zone-wide CPU
utilization for that service</p>
</li>
<li>
<p>a heat map for each service showing the zone-wide CPU utilization for each
zone in that service</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The rest of this guide makes reference to "checking recent historical metrics".
This refers to using one of these dashboards to observe these metrics, typically
for a period before and during an incident.</p>
</div>
<div class="paragraph">
<p>(Unfortunately, there is not much documentation yet on the metrics available from
Manta or how to create these dashboards.  Specific metrics are often documented
with the components that provide them.)</p>
</div>
<div class="paragraph">
<p>For more information about Grafana (including how to build dashboards and
interact with them), see the
<a href="http://docs.grafana.org/guides/basic_concepts/">Grafana documentation</a>.</p>
</div>
<div class="paragraph">
<p>For more information about Prometheus, see the
<a href="https://prometheus.io/docs/introduction/overview/">official Prometheus
documentation</a>.</p>
</div>
<div class="paragraph">
<p>Once these dashboards are created, it&#8217;s recommended to create a landing page for
incident responders that links to this guide as well as the endpoints for
viewing these dashboars.  Any credentials needed for these endpoints should be
document or distributed to responders.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_metrics">Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Real-time metrics provided by Manta form the basis of situational awareness,
particularly during incident response.  Metrics are available for most data path
components.  Understanding these metrics requires a basic understanding of these
components and how they work together.  For more on these components, see
<a href="http://joyent.github.io/manta/#components-of-manta">Components of Manta</a> in the
Operator Guide.</p>
</div>
<div class="paragraph">
<p>Manta components expose metrics, but within any given Manta deployment, it&#8217;s up
to operators to set up systems for collecting, presenting, and alerting on
metrics.  For more, see <a href="#_deployment_specific_details">Deployment-specific details</a>.</p>
</div>
<div class="paragraph">
<p>This section uses screenshots from existing deployments to discuss metrics
provided by Manta and how to interpret them.  The specific metrics available and
the appearance of graphs may vary in your deployment.</p>
</div>
<div class="sect2">
<h3 id="_predicting_autovacuum_activity">Predicting autovacuum activity</h3>
<div class="sect3">
<h4 id="_background_on_vacuum_in_manta">Background on vacuum in Manta</h4>
<div class="paragraph">
<p>Autovacuum activity in PostgreSQL is a major source of degraded performance in
large deployments, known to cause a throughput degradation as much as 70% on a
per-shard basis.  It&#8217;s helpful for operators to understand some of the basics of
autovacuum.  A deeper understanding requires digging rather deep into
PostgreSQL internals.  The PostgreSQL documentation describes
<a href="https://www.postgresql.org/docs/9.6/static/routine-vacuuming.html">autovacuum,
the reason for it, and the conditions for it</a> in detail.</p>
</div>
<div class="paragraph">
<p>Operators should understand at least the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"Vacuum" is a long-running activity that runs on a per-table basis.  This is a
maintenance operation that generally has to be run periodically on all
tables in all PostgreSQL databases.</p>
</li>
<li>
<p>"Autovacuum" is the name for any vacuum that is scheduled and managed by
PostgreSQL itself, as opposed to one that an operator kicks off explicitly.</p>
</li>
<li>
<p>Manta has two primary tables: "manta" and "manta_directory_counts".  As
mentioned above, each vacuum operation runs on one table at a time (though
multiple vacuums can be running at the same time on different tables.)</p>
</li>
<li>
<p>There&#8217;s generally a significant degradation in both average query latency and
tail latency while vacuum is running.  In fixed-concurrency deployments (i.e.,
when there are a fixed number of clients), an increase in average latency
corresponds directly to a decrease in throughput.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We classify vacuum operations into two types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Normal vacuums clean up tuples (rows) in the table that have been invalidated
since the last vacuum (usually by <code>UPDATE</code> and <code>DELETE</code> operations).
PostgreSQL kicks these off whenever the fraction of dead tuples exceeds a
configurable threshold of the table size, which is generally 20%.</p>
</li>
<li>
<p>"Anti-wraparound vacuums" (also sometimes called "wraparound vacuums", "freeze
vacuums", or "aggressive vacuums") are responsible for freezing old tuples.
PostgreSQL kicks these off whenever it&#8217;s been more than a fixed number of
transactions since the last time this was done.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that each type of vacuum may do the work of the other.  A normal vacuum may
freeze some tuples, and a freeze vacuum will generally clean up dead tuples.
This classification is about what <em>caused</em> PostgreSQL to start the vacuum, and
it&#8217;s useful because we can monitor the underlying metrics in order to predict
when PostgreSQL will kick off vacuum operations.</p>
</div>
<div class="paragraph">
<p>Again, there&#8217;s significantly more information about all of this in the
above-linked PostgreSQL documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_metrics_to_predict_normal_autovacuums">Using metrics to predict normal autovacuums</h4>
<div class="paragraph">
<p>As mentioned above, a normal vacuum is kicked off when the number of dead tuples
has exceeded 20% of the total tuples in the table.  We can see this in Manta
metrics.  Here&#8217;s a graph of live tuples, dead tuples, and the fraction of dead
tuples for a made-up table called "test_table" (normally in Manta this would be
the "manta" or "manta_directory_counts" table):</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-postgresql-tuples-autovac.png" alt="metrics postgresql tuples autovac">
</div>
<div class="title">Figure 7. A graph of dead tuples, live tuples, and autovacuum activity in a test environment.</div>
</div>
<div class="paragraph">
<p>In this graph:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the upper graph, the green line shows live tuples.  This system is running
a heavy INSERT workload, so the count of live tuples increases relatively
constantly.</p>
</li>
<li>
<p>In the upper graph, the yellow line shows dead tuples.  A fraction of this
workload runs UPDATE queries, so there&#8217;s a steady increase in dead tuples as
well.</p>
</li>
<li>
<p>In the upper graph, the blue line (which goes with the right-hand y-axis)
shows the percentage of tuples in the table that are dead.  This value also
climbs, though not at a linear rate.</p>
</li>
<li>
<p>In the bottom graph, the green bars represent periods where a normal vacuum
was running.  (You can ignore the yellow bars in this graph.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Critically <strong>autovacuum starts running when the blue line reaches 20%, for the
reasons described above.</strong> Further, when vacuum finishes, the count (and
fraction) of dead tuples decreases suddenly&#8201;&#8212;&#8201;because vacuum has cleaned up
those dead tuples.  As a result, <strong>the blue line can be used to predict when
normal vacuums will kick off.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_metrics_to_predict_anti_wraparound_autovacuums">Using metrics to predict anti-wraparound autovacuums</h4>
<div class="paragraph">
<p>As mentioned above, an anti-wraparound vacuum is kicked off on a table when the
number of transactions in a database that have been executed since the last such
vacuum exceeds some threshold.  Manta exposes this metric as well.</p>
</div>
<div class="paragraph">
<p>Typically, as a workload runs, the transactions-until-wraparound-vacuum
decreases at a rate determined by how many transactions are running in the
database.  For a single shard, we can plot this on a line graph (one graph for
each major table):</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-postgresql-wraparound-leadup.png" alt="metrics postgresql wraparound leadup">
</div>
<div class="title">Figure 8. Graphs of the number of transactions left until the next wraparound autovacuum kicks off for the "manta" and "manta_directory_counts" tables.</div>
</div>
<div class="paragraph">
<p>For a large number of shards, we can plot this as a heat map, which helps us see
the pattern across shards:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-postgresql-wraparound-leadup-heatmap.png" alt="metrics postgresql wraparound leadup heatmap">
</div>
<div class="title">Figure 9. Heat maps of the number of transactions left until the next wraparound autovacuum.  Brighter blocks indicate a larger number of data points (shards).</div>
</div>
<div class="paragraph">
<p>In the right-hand heat map, the bright line above 400M indicates that most
shards are over 400 million transactions away from the next wraparound
autovacuum.  The darker line around 100M shows that a smaller number are much
closer to the threshold.  The left-hand heat map shows much greater variance for
the "manta" table, though there&#8217;s a cluster (a bright line) just under 100M
transactions from the next wraparound autovacuum.</p>
</div>
<div class="paragraph">
<p>When any of these lines reaches zero, that means we&#8217;d PostgreSQL to kick off a
wraparound autovacuum.  The line will continue decreasing (to negative numbers)
until the wraparound autovacuum completes, at which point it will jump back up.
Here, we can see a whole wraparound autovacuum cycle:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/metrics-postgresql-wraparound-duration.png" alt="metrics postgresql wraparound duration">
</div>
<div class="title">Figure 10. Graphs of the number of transactions until the next wraparound autovacuum, plus the number of wraparound autovacuums running, for a particular shard over the course of one autovacuum operation.</div>
</div>
<div class="paragraph">
<p>We see here that we&#8217;d expect a wraparound autovacuum to kick off when the
threshold reaches 0.  It keeps falling until the vacuum completes, at which
point it jumps back up.  Another round will kick off when the line reaches zero
again.  (Note that the lower graph here is a prediction, based directly on the
graph above it.  It&#8217;s possible (though not common in practice) that PostgreSQL
won&#8217;t actually have kicked off the wraparound autovacuum at this time.)</p>
</div>
<div class="paragraph">
<p>Because of this behavior, the graph of transactions until wraparound autovacuum
can be used to predict when wraparound autovacuums will kick off for each shard.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-03-28 13:49:38 PDT
</div>
</div>
</body>
</html>